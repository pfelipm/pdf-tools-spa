<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramientas PDF - Suite Local</title>
    <meta name="description" content="Suite de herramientas PDF segura y privada: Unir, Dividir, Organizar y Convertir a Im치genes. Procesamiento 100% local en tu navegador.">
    <meta name="author" content="Pablo Felip">

    <!-- Favicon (Emoji Documento) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游늯</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <!-- Librer칤as -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // Init Dark Mode Immediately
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const { PDFDocument, degrees, rgb } = PDFLib;
    </script>

    <style>
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark .custom-scroll::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #4b5563; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .dark .loader { border-color: #374151; border-top-color: #60a5fa; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilos Drag & Drop */
        .sortable-ghost {
            opacity: 1 !important;
            background-color: #eff6ff !important;
            border: 2px dashed #3b82f6 !important;
            box-shadow: none !important;
            transform: scale(0.95);
        }
        .dark .sortable-ghost { background-color: #1e3a8a !important; border-color: #60a5fa !important; }
        .sortable-ghost > * { opacity: 0 !important; }

        .sortable-drag {
            cursor: grabbing;
            opacity: 1 !important;
            background: white;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2);
            transform: scale(1.05);
            z-index: 50;
        }
        .dark .sortable-drag { background: #1f2937; }

        .merge-ghost { opacity: 0.5; background: #eff6ff; border: 1px dashed #3b82f6; }
        .dark .merge-ghost { background: #1e3a8a; border-color: #60a5fa; }

        .merge-drag { cursor: grabbing; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 50; }
        .dark .merge-drag { background: #1f2937; }

        .tab-content { display: none; }
        .tab-content.active { display: flex; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Editor Specific Styles */
        .page-thumbnail.active { border-color: #3b82f6; background-color: #eff6ff; }
        .dark .page-thumbnail.active { border-color: #60a5fa; background-color: #1e3a8a; }
        #canvas-wrapper { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans text-gray-800 overflow-hidden dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200">

    <!-- Header (Centrado Absoluto) -->
    <header class="bg-white border-b border-gray-200 flex-none z-20 shadow-sm flex items-center justify-between px-6 py-3 relative dark:bg-gray-800 dark:border-gray-700">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 p-2 rounded-lg text-white shadow-md">
                <i data-lucide="files" class="w-6 h-6"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800 tracking-tight dark:text-white">Herramientas PDF</h1>
        </div>

        <nav class="flex gap-1 bg-gray-100 p-1 rounded-lg absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 dark:bg-gray-700">
            <button onclick="switchTab('merge')" id="tab-merge" class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-white text-blue-600 shadow-sm flex items-center gap-2 dark:bg-gray-600 dark:text-blue-300">
                <i data-lucide="combine" class="w-4 h-4"></i> Unir
            </button>
            <button onclick="switchTab('split')" id="tab-split" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-700 flex items-center gap-2 dark:text-gray-400 dark:hover:text-gray-200">
                <i data-lucide="scissors" class="w-4 h-4"></i> Dividir
            </button>
            <button onclick="switchTab('organize')" id="tab-organize" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-700 flex items-center gap-2 dark:text-gray-400 dark:hover:text-gray-200">
                <i data-lucide="layout-grid" class="w-4 h-4"></i> Organizar
            </button>
            <button onclick="switchTab('images')" id="tab-images" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-700 flex items-center gap-2 dark:text-gray-400 dark:hover:text-gray-200">
                <i data-lucide="image" class="w-4 h-4"></i> A im치genes
            </button>
            <button onclick="switchTab('editor')" id="tab-editor" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-gray-500 hover:text-gray-700 flex items-center gap-2 dark:text-gray-400 dark:hover:text-gray-200">
                <i data-lucide="pencil" class="w-4 h-4"></i> Editar
            </button>
        </nav>

        <div class="flex items-center gap-3">
            <button id="theme-toggle" class="text-gray-400 hover:text-blue-600 transition-colors p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-blue-400" title="Cambiar tema">
                <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
            </button>
            <button id="about-btn" class="text-gray-400 hover:text-blue-600 transition-colors p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 dark:hover:text-blue-400" title="Sobre este proyecto">
                <i data-lucide="info" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 relative overflow-hidden flex flex-col">
        
        <!-- TAB 5: EDITOR -->
        <section id="content-editor" class="tab-content flex-col h-full relative bg-gray-100 dark:bg-gray-900">
             <!-- Editor Upload View -->
             <div id="editor-upload" class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-50 dark:bg-gray-900 absolute inset-0 z-50">
                <div class="bg-white p-12 rounded-2xl shadow-sm border border-gray-200 text-center max-w-md w-full dark:bg-gray-800 dark:border-gray-700">
                    <div class="bg-purple-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-purple-600 dark:bg-gray-700 dark:text-purple-400">
                        <i data-lucide="pencil" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 dark:text-white">Editor visual PDF</h2>
                    <p class="text-gray-500 mb-8 dark:text-gray-400">A침ade texto, formas, dibujos y numeraci칩n.</p>
                    <input type="file" id="editorInput" accept="application/pdf" class="hidden">
                    <button onclick="document.getElementById('editorInput').click()" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-3 rounded-xl font-medium transition shadow-sm dark:bg-purple-500 dark:hover:bg-purple-600">
                        Seleccionar PDF
                    </button>
                </div>
            </div>

            <!-- Editor Interface -->
            <div id="editor-workspace" class="hidden flex flex-col h-full w-full">
                <!-- Toolbar -->
                <div class="h-14 bg-white border-b border-gray-200 flex items-center px-4 justify-between shadow-sm z-20 dark:bg-gray-800 dark:border-gray-700">
                    
                    <!-- Group 1: History & Zoom -->
                    <div class="flex items-center gap-2 border-r border-gray-200 pr-4 mr-2 dark:border-gray-600">
                        <button onclick="editorUndo()" class="p-2 hover:bg-gray-100 rounded text-gray-600 dark:text-gray-300 dark:hover:bg-gray-700" title="Deshacer (Ctrl+Z)"><i data-lucide="undo" class="w-4 h-4"></i></button>
                        <button onclick="editorRedo()" class="p-2 hover:bg-gray-100 rounded text-gray-600 dark:text-gray-300 dark:hover:bg-gray-700" title="Rehacer (Ctrl+Y)"><i data-lucide="redo" class="w-4 h-4"></i></button>
                        <div class="flex items-center gap-1 ml-2 bg-gray-50 rounded-lg p-1 dark:bg-gray-700">
                            <button onclick="editorZoom(-0.1)" class="p-1 hover:bg-gray-200 rounded text-gray-600 dark:text-gray-300 dark:hover:bg-gray-600"><i data-lucide="minus" class="w-3 h-3"></i></button>
                            <span id="editor-zoom-display" class="text-xs font-mono w-10 text-center dark:text-gray-200">100%</span>
                            <button onclick="editorZoom(0.1)" class="p-1 hover:bg-gray-200 rounded text-gray-600 dark:text-gray-300 dark:hover:bg-gray-600"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>
                        <button onclick="editorFitPage()" class="p-2 hover:bg-gray-100 rounded text-gray-600 ml-1 dark:text-gray-300 dark:hover:bg-gray-700" title="Ajustar a p치gina"><i data-lucide="maximize" class="w-4 h-4"></i></button>
                    </div>

                    <!-- Group 2: Tools -->
                    <div class="flex items-center gap-1">
                        <button onclick="setEditorMode('select')" id="tool-select" class="tool-btn active p-2 rounded text-purple-600 bg-purple-50 dark:text-purple-300 dark:bg-purple-900/30" title="Seleccionar"><i data-lucide="mouse-pointer-2" class="w-5 h-5"></i></button>
                        <button onclick="setEditorMode('pixelate')" id="tool-pixelate" class="tool-btn p-2 rounded text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700" title="Censurar / Pixelar"><i data-lucide="eye-off" class="w-5 h-5"></i></button>
                        <button onclick="addText()" class="tool-btn p-2 rounded text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700" title="Texto"><i data-lucide="type" class="w-5 h-5"></i></button>
                        <button onclick="document.getElementById('img-upload-input').click()" class="tool-btn p-2 rounded text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700" title="Insertar Imagen"><i data-lucide="image-plus" class="w-5 h-5"></i></button>
                        <input type="file" id="img-upload-input" accept="image/png, image/jpeg, image/jpg" class="hidden" onchange="handleAddImage(this)">
                        <button onclick="addPageNumber()" class="tool-btn p-2 rounded text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700" title="Numerar p치ginas"><i data-lucide="hash" class="w-5 h-5"></i></button>
                        
                        <div class="relative group">
                            <button class="tool-btn p-2 rounded text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 flex items-center gap-1">
                                <i data-lucide="shapes" class="w-5 h-5"></i> <i data-lucide="chevron-down" class="w-3 h-3"></i>
                            </button>
                            <div class="absolute top-full left-0 mt-1 before:block before:absolute before:-top-2 before:left-0 before:w-full before:h-4 bg-white border border-gray-200 rounded-lg shadow-lg hidden group-hover:block w-32 py-1 z-50 dark:bg-gray-800 dark:border-gray-600">
                                <button onclick="addShape('rect')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">Rect치ngulo</button>
                                <button onclick="addShape('circle')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">C칤rculo</button>
                                <button onclick="addShape('triangle')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">Tri치ngulo</button>
                                <button onclick="addShape('star')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">Estrella</button>
                                <button onclick="addShape('line')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">L칤nea</button>
                                <button onclick="addShape('arrow')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">Flecha</button>
                                <div class="border-t border-gray-100 my-1 dark:border-gray-700"></div>
                                <button onclick="addIcon('smile')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">游뗵 Feliz</button>
                                <button onclick="addIcon('sad')" class="block w-full text-left px-3 py-2 text-sm hover:bg-gray-50 dark:text-gray-200 dark:hover:bg-gray-700">游뗴 Triste</button>
                            </div>
                        </div>

                        <button onclick="toggleDrawMode()" id="tool-draw" class="tool-btn p-2 rounded text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700" title="Dibujar"><i data-lucide="pen-tool" class="w-5 h-5"></i></button>
                    </div>

                    <!-- Group 3: Final Actions -->
                    <div class="flex items-center gap-2 border-l border-gray-200 pl-4 ml-2 dark:border-gray-600">
                        <div class="relative group">
                            <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition shadow-sm flex items-center gap-2 dark:bg-purple-500 dark:hover:bg-purple-600">
                                <i data-lucide="save" class="w-4 h-4"></i> Guardar <i data-lucide="chevron-down" class="w-3 h-3 ml-1"></i>
                            </button>
                            <div class="absolute top-full right-0 mt-1 before:block before:absolute before:-top-2 before:left-0 before:w-full before:h-4 bg-white border border-gray-200 rounded-lg shadow-xl hidden group-hover:block w-56 py-1 z-50 dark:bg-gray-800 dark:border-gray-600">
                                <button onclick="editorSave()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-start gap-3 dark:text-gray-200 dark:hover:bg-gray-700 transition-colors">
                                    <i data-lucide="file-edit" class="w-5 h-5 text-gray-400 mt-0.5 dark:text-gray-500"></i>
                                    <div>
                                        <span class="font-bold block text-gray-700 dark:text-gray-200">Guardar PDF</span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">Editable (capas)</span>
                                    </div>
                                </button>
                                <div class="border-t border-gray-100 dark:border-gray-700"></div>
                                <button onclick="openFlattenModal()" class="w-full text-left px-4 py-3 text-sm hover:bg-gray-50 flex items-start gap-3 dark:text-gray-200 dark:hover:bg-gray-700 transition-colors">
                                    <i data-lucide="layers" class="w-5 h-5 text-purple-600 mt-0.5 dark:text-purple-400"></i>
                                    <div>
                                        <span class="font-bold block text-purple-600 dark:text-purple-400">Aplanar PDF</span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">Seguro (rasterizado)</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                        <button onclick="resetTool('editor')" class="p-2 text-gray-400 hover:text-red-600 transition" title="Cerrar Editor"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="flex-1 flex overflow-hidden">
                    <!-- Sidebar (Thumbnails) -->
                    <div id="editor-sidebar" class="w-48 bg-gray-50 border-r border-gray-200 overflow-y-auto flex flex-col p-4 gap-4 custom-scroll z-10 dark:bg-gray-800 dark:border-gray-700">
                        <!-- Thumbnails will be injected here -->
                    </div>

                    <!-- Workspace (Canvas) -->
                    <div class="flex-1 bg-gray-200 overflow-auto flex p-8 relative custom-scroll dark:bg-gray-900/50" id="editor-scroll-area">
                        <div id="canvas-wrapper" class="bg-white shadow-2xl relative m-auto flex-shrink-0">
                            <!-- Background Canvas (PDF.js) -->
                            <canvas id="pdf-render" class="absolute inset-0 pointer-events-none w-full h-full"></canvas>
                            <!-- Foreground Canvas (Fabric.js) -->
                            <canvas id="fabric-canvas" class="w-full h-full"></canvas>
                        </div>
                    </div>

                    <!-- Right Sidebar (Properties) -->
                    <div id="editor-properties" class="w-64 bg-white border-l border-gray-200 overflow-y-auto p-4 flex flex-col gap-6 shadow-lg z-10 dark:bg-gray-800 dark:border-gray-700">
                        <div class="text-center text-gray-400 mt-10 text-sm">
                            <i data-lucide="mouse-pointer-click" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p>Selecciona un objeto para editarlo</p>
                        </div>
                        <!-- Dynamic properties injected via JS -->
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB 1: UNIR (MERGE) -->
        <section id="content-merge" class="tab-content flex-col h-full active">
            <div class="flex-1 p-8 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto">
                    <div id="merge-drop-zone" class="bg-white rounded-2xl shadow-sm border-2 border-dashed border-gray-300 p-10 text-center mb-8 hover:border-blue-500 transition-colors cursor-pointer group dark:bg-gray-800 dark:border-gray-600 dark:hover:border-blue-400">
                        <div class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 group-hover:scale-110 transition-transform dark:bg-gray-700 dark:text-blue-400">
                            <i data-lucide="combine" class="w-8 h-8"></i>
                        </div>
                        <h2 class="text-xl font-bold mb-2 text-gray-800 dark:text-white">Unir archivos</h2>
                        <p class="text-gray-500 mb-6 dark:text-gray-400">Arrastra PDFs o im치genes (JPG, PNG) aqu칤.</p>
                        <input type="file" id="mergeInput" multiple accept=".pdf,.jpg,.jpeg,.png" class="hidden">
                        <button onclick="document.getElementById('mergeInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl font-medium transition shadow-sm inline-flex items-center gap-2 dark:bg-blue-500 dark:hover:bg-blue-600">
                            <i data-lucide="plus" class="w-4 h-4"></i> Seleccionar archivos
                        </button>
                    </div>

                    <div id="mergeList" class="space-y-3"></div>

                    <div id="merge-result-actions" class="hidden mt-6 bg-green-50 p-6 rounded-xl border border-green-200 animate-fade-in text-center dark:bg-green-900/20 dark:border-green-800">
                        <div class="flex flex-col items-center justify-center gap-2 mb-4">
                            <i data-lucide="check-circle-2" class="w-10 h-10 text-green-600 dark:text-green-400"></i>
                            <span class="text-lg font-bold text-green-800 dark:text-green-300">춰Archivos unidos con 칠xito!</span>
                        </div>
                        <div class="flex flex-wrap justify-center gap-3">
                            <button id="merge-download-btn" class="px-5 py-2.5 bg-green-600 text-white hover:bg-green-700 rounded-lg font-medium transition shadow-sm flex items-center gap-2 dark:bg-green-500 dark:hover:bg-green-600">
                                <i data-lucide="download" class="w-4 h-4"></i> Descargar
                            </button>
                            <span class="border-r border-green-300 mx-2 dark:border-green-700"></span>
                            <button id="merge-to-organize-btn" class="px-4 py-2 bg-white border border-green-300 text-green-700 hover:bg-green-100 rounded-lg font-medium transition text-sm flex items-center gap-2 dark:bg-gray-800 dark:border-gray-600 dark:text-green-400 dark:hover:bg-gray-700">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i> Organizar
                            </button>
                            <button id="merge-to-editor-btn" class="px-4 py-2 bg-white border border-green-300 text-green-700 hover:bg-green-100 rounded-lg font-medium transition text-sm flex items-center gap-2 dark:bg-gray-800 dark:border-gray-600 dark:text-green-400 dark:hover:bg-gray-700">
                                <i data-lucide="pencil" class="w-4 h-4"></i> Editar
                            </button>
                            <button id="merge-to-images-btn" class="px-4 py-2 bg-white border border-green-300 text-green-700 hover:bg-green-100 rounded-lg font-medium transition text-sm flex items-center gap-2 dark:bg-gray-800 dark:border-gray-600 dark:text-green-400 dark:hover:bg-gray-700">
                                <i data-lucide="images" class="w-4 h-4"></i> A im치genes
                            </button>
                            <button id="merge-to-split-btn" class="px-4 py-2 bg-white border border-green-300 text-green-700 hover:bg-green-100 rounded-lg font-medium transition text-sm flex items-center gap-2 dark:bg-gray-800 dark:border-gray-600 dark:text-green-400 dark:hover:bg-gray-700">
                                <i data-lucide="scissors" class="w-4 h-4"></i> Dividir
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white border-t border-gray-200 p-4 pb-10 flex justify-between items-center z-10 px-8 dark:bg-gray-800 dark:border-gray-700">
                <button onclick="clearMergeList()" class="text-gray-500 hover:text-red-600 text-sm font-medium transition dark:text-gray-400 dark:hover:text-red-400">Limpiar lista</button>
                <div class="flex gap-4 items-center">
                    <span id="merge-file-count" class="text-sm text-gray-500 dark:text-gray-400">0 archivos</span>
                    <button id="mergeBtn" disabled class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-8 py-2.5 rounded-xl font-bold transition shadow-md flex items-center gap-2 dark:bg-blue-500 dark:hover:bg-blue-600">
                        <i data-lucide="layers" class="w-4 h-4"></i> Unir Archivos
                    </button>
                </div>
            </div>
        </section>

        <!-- TAB 2: DIVIDIR (SPLIT) -->
        <section id="content-split" class="tab-content flex-col h-full">
             <div id="split-upload" class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-50 dark:bg-gray-900">
                <div class="bg-white p-12 rounded-2xl shadow-sm border border-gray-200 text-center max-w-md w-full dark:bg-gray-800 dark:border-gray-700">
                    <div class="bg-indigo-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600 dark:bg-gray-700 dark:text-indigo-400">
                        <i data-lucide="scissors" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 dark:text-white">Dividir PDF</h2>
                    <p class="text-gray-500 mb-8 dark:text-gray-400">Extrae rangos de p치ginas o divide en m칰ltiples archivos.</p>
                    <input type="file" id="splitInput" accept="application/pdf" class="hidden">
                    <button onclick="document.getElementById('splitInput').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-medium transition shadow-sm dark:bg-indigo-500 dark:hover:bg-indigo-600">
                        Seleccionar PDF
                    </button>
                </div>
            </div>

            <div id="split-workspace" class="hidden flex-1 flex overflow-hidden">
                <div class="flex-1 bg-gray-100 p-6 overflow-y-auto custom-scroll dark:bg-gray-900">
                    <div id="splitGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 max-w-6xl mx-auto"></div>
                </div>

                <aside class="w-80 bg-white border-l border-gray-200 flex flex-col p-6 shadow-xl z-10 overflow-y-auto dark:bg-gray-800 dark:border-gray-700">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2 text-lg dark:text-white"><i data-lucide="settings-2" class="w-5 h-5 text-indigo-600 dark:text-indigo-400"></i> Opciones</h3>

                    <div class="space-y-6 flex-1">
                        <div class="space-y-3">
                            <label class="flex items-start p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-indigo-900/30 dark:has-[:checked]:border-indigo-400">
                                <input type="radio" name="split-mode" value="range" checked class="mt-1 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-500">
                                <div class="ml-3">
                                    <span class="block text-sm font-medium text-gray-900 dark:text-white">Extraer p치ginas/rangos</span>
                                    <span class="block text-xs text-gray-500 dark:text-gray-400">Crea archivos seg칰n selecci칩n.</span>
                                </div>
                            </label>

                            <div id="range-input-container" class="ml-2 pl-4 border-l-2 border-indigo-100 dark:border-gray-600">
                                <label class="block text-xs font-semibold text-gray-500 mb-1 dark:text-gray-400">P치ginas (ej: 1-5, 8, 10-)</label>
                                <input type="text" id="split-range-input" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="1, 3-5, 8, -5">
                            </div>

                            <label class="flex items-start p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-indigo-500 has-[:checked]:bg-indigo-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-indigo-900/30 dark:has-[:checked]:border-indigo-400">
                                <input type="radio" name="split-mode" value="all" class="mt-1 text-indigo-600 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-500">
                                <div class="ml-3">
                                    <span class="block text-sm font-medium text-gray-900 dark:text-white">Dividir todas</span>
                                    <span class="block text-xs text-gray-500 dark:text-gray-400">Una p치gina por archivo.</span>
                                </div>
                            </label>
                        </div>

                        <div class="pt-4 border-t border-gray-100 dark:border-gray-700">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="split-zip-check" class="rounded text-indigo-600 focus:ring-indigo-500 w-4 h-4 dark:bg-gray-700 dark:border-gray-500">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Comprimir resultados en ZIP</span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <span id="splitCount" class="text-sm font-medium text-gray-600 dark:text-gray-400">0 sel.</span>
                            <div class="flex gap-2">
                                <button onclick="clearSplitSelection()" class="text-xs text-red-500 hover:text-red-700 font-medium px-2 py-1 bg-red-50 rounded dark:bg-red-900/30 dark:text-red-400 dark:hover:text-red-300">Limpiar</button>
                                <button onclick="toggleSplitSelection()" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium px-2 py-1 bg-indigo-50 rounded dark:bg-indigo-900/30 dark:text-indigo-400 dark:hover:text-indigo-300">Invertir</button>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <button onclick="processSplit()" id="splitBtn" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold hover:bg-indigo-700 disabled:opacity-50 transition shadow-md flex justify-center gap-2 dark:bg-indigo-500 dark:hover:bg-indigo-600">
                                <i data-lucide="download" class="w-5 h-5"></i> Dividir PDF
                            </button>
                            <button onclick="resetTool('split')" class="w-full text-gray-500 py-2 text-sm hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400">Cancelar</button>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

        <!-- TAB 3: ORGANIZAR -->
        <section id="content-organize" class="tab-content flex-col h-full">
            <div id="organize-upload" class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-50 dark:bg-gray-900">
                <div class="bg-white p-12 rounded-2xl shadow-sm border border-gray-200 text-center max-w-md w-full dark:bg-gray-800 dark:border-gray-700">
                    <div class="bg-orange-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-600 dark:bg-gray-700 dark:text-orange-400">
                        <i data-lucide="layout-grid" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 dark:text-white">Organizar PDF</h2>
                    <p class="text-gray-500 mb-8 dark:text-gray-400">Reordena, rota o elimina p치ginas.</p>
                    <input type="file" id="organizeInput" accept="application/pdf" class="hidden">
                    <button onclick="document.getElementById('organizeInput').click()" class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-3 rounded-xl font-medium transition shadow-sm dark:bg-orange-500 dark:hover:bg-orange-600">Seleccionar PDF</button>
                </div>
            </div>
            <div id="organize-workspace" class="hidden flex-1 flex flex-col h-full overflow-hidden">
                <div class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10 dark:bg-gray-800 dark:border-gray-700">
                    <div class="flex items-center gap-3">
                         <span class="font-bold text-gray-700 truncate max-w-xs dark:text-gray-200" id="organize-filename">doc.pdf</span>
                         <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full dark:bg-gray-700 dark:text-gray-300" id="organize-page-count">0 p치gs</span>
                    </div>
                    <button onclick="resetTool('organize')" class="text-gray-500 hover:text-red-600 text-sm font-medium flex items-center gap-1 dark:text-gray-400 dark:hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i> Reiniciar</button>
                </div>
                <div class="flex-1 bg-gray-100 p-8 overflow-y-auto custom-scroll dark:bg-gray-900">
                    <div id="organizeGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6 max-w-7xl mx-auto"></div>
                </div>
                <div class="bg-white border-t border-gray-200 p-4 flex justify-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20 dark:bg-gray-800 dark:border-gray-700">
                    <button id="organize-save-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-10 py-3 rounded-xl font-bold transition shadow-lg hover:shadow-orange-200 flex items-center gap-2 dark:bg-orange-500 dark:hover:bg-orange-600"><i data-lucide="save" class="w-5 h-5"></i> Guardar PDF Organizado</button>
                </div>
            </div>
        </section>

        <!-- TAB 4: IM츼GENES -->
        <section id="content-images" class="tab-content flex-col h-full">
            <div id="images-upload" class="flex-1 flex flex-col items-center justify-center p-6 bg-gray-50 dark:bg-gray-900">
                <div class="bg-white p-12 rounded-2xl shadow-sm border border-gray-200 text-center max-w-md w-full dark:bg-gray-800 dark:border-gray-700">
                    <div class="bg-green-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-green-600 dark:bg-gray-700 dark:text-green-400">
                        <i data-lucide="images" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 dark:text-white">PDF a im치genes</h2>
                    <p class="text-gray-500 mb-8 dark:text-gray-400">Convierte p치ginas a JPG o PNG.</p>
                    <input type="file" id="imagesInput" accept="application/pdf" class="hidden">
                    <button onclick="document.getElementById('imagesInput').click()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl font-medium transition shadow-sm dark:bg-green-500 dark:hover:bg-green-600">Seleccionar PDF</button>
                </div>
            </div>
            <div id="images-workspace" class="hidden flex-1 flex overflow-hidden">
                <div class="flex-1 bg-gray-100 p-6 overflow-y-auto custom-scroll relative dark:bg-gray-900">
                    <div id="imagesGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 max-w-6xl mx-auto pb-20"></div>
                </div>
                <aside class="w-80 bg-white border-l border-gray-200 flex flex-col z-10 shadow-lg p-6 overflow-y-auto dark:bg-gray-800 dark:border-gray-700">
                    <div class="border-b border-gray-100 pb-4 mb-4 dark:border-gray-700">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2 dark:text-white"><i data-lucide="sliders-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i> Opciones</h3>
                    </div>
                    <div class="space-y-6 flex-1">
                        <!-- Format & DPI -->
                        <div class="space-y-3">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide">Salida</label>
                            <div class="flex gap-2">
                                <label class="flex-1 flex items-center justify-center p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-green-900/30 dark:has-[:checked]:border-green-400">
                                    <input type="radio" name="imgFormat" value="jpeg" checked class="sr-only">
                                    <span class="text-sm font-medium dark:text-gray-200">JPG</span>
                                </label>
                                <label class="flex-1 flex items-center justify-center p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-green-900/30 dark:has-[:checked]:border-green-400">
                                    <input type="radio" name="imgFormat" value="png" class="sr-only">
                                    <span class="text-sm font-medium dark:text-gray-200">PNG</span>
                                </label>
                            </div>
                            <select id="imgDpi" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm outline-none bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="72">72 DPI (pantalla)</option>
                                <option value="150" selected>150 DPI (media)</option>
                                <option value="300">300 DPI (alta)</option>
                            </select>
                        </div>

                        <!-- Selection Mode (Like Split) -->
                        <div class="space-y-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide">Selecci칩n</label>
                            <label class="flex items-start p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-green-900/30 dark:has-[:checked]:border-green-400">
                                <input type="radio" name="img-mode" value="range" checked class="mt-1 text-green-600 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-500">
                                <div class="ml-3"><span class="block text-sm font-medium text-gray-900 dark:text-white">Por Rango</span></div>
                            </label>

                            <!-- Visual Match Split -->
                            <div class="ml-2 pl-4 border-l-2 border-green-100 dark:border-gray-600">
                                <label class="block text-xs font-semibold text-gray-500 mb-1 dark:text-gray-400">P치ginas (ej: 1-5, 8, 10-)</label>
                                <input type="text" id="img-range-input" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-green-500 outline-none dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="1, 3-5, 8">
                            </div>

                            <label class="flex items-start p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-green-900/30 dark:has-[:checked]:border-green-400">
                                <input type="radio" name="img-mode" value="all" class="mt-1 text-green-600 focus:ring-green-500 dark:bg-gray-700 dark:border-gray-500">
                                <div class="ml-3"><span class="block text-sm font-medium text-gray-900 dark:text-white">Todas las p치ginas</span></div>
                            </label>
                        </div>

                        <!-- ZIP Option -->
                        <div class="pt-3 border-t border-gray-100 dark:border-gray-700">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="img-zip-check" class="rounded text-green-600 focus:ring-green-500 w-4 h-4 dark:bg-gray-700 dark:border-gray-500" checked>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Descargar como ZIP</span>
                            </label>
                        </div>
                    </div>

                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <span id="imgSelectionCount" class="text-sm font-medium text-gray-600 dark:text-gray-400">0 sel.</span>
                            <div class="flex gap-2">
                                <button onclick="clearImgSelection()" class="text-xs text-red-500 hover:text-red-700 font-medium px-2 py-1 bg-red-50 rounded dark:bg-red-900/30 dark:text-red-400 dark:hover:text-red-300">Limpiar</button>
                                <button onclick="toggleImgSelection()" class="text-xs text-green-600 hover:text-green-800 font-medium px-2 py-1 bg-green-50 rounded dark:bg-green-900/30 dark:text-green-400 dark:hover:text-green-300">Invertir</button>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <button id="imgProcessBtn" disabled onclick="processImages()" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-green-700 disabled:opacity-50 transition shadow-sm flex items-center justify-center gap-2 dark:bg-green-500 dark:hover:bg-green-600"><i data-lucide="download" class="w-5 h-5"></i> Descargar</button>
                            <button onclick="resetTool('images')" class="w-full text-gray-500 py-2 text-sm hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400">Cancelar</button>
                        </div>
                    </div>
                </aside>
            </div>
        </section>

    </main>

    <!-- Modal About -->
    <div id="about-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative animate-fade-in dark:bg-gray-800">
            <button id="close-about-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="text-center">
                <img src="https://drive.google.com/thumbnail?id=1pbNyTrnZeZvfWLu2Lm66f9tVQ3OqTKHx&sz=w500-h500" alt="Pablo Felip" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg mb-4 object-cover dark:border-gray-700">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">Pablo Felip</h2>
                <p class="text-sm text-gray-500 mb-4 dark:text-gray-400">Docente de Formaci칩n Profesional y Universidad, TICnol칩gicamente inquieto.</p>
                <p class="text-sm text-gray-600 mb-6 leading-relaxed bg-gray-50 p-3 rounded-lg border border-gray-100 text-left dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300">
                    Esta versi칩n web (SPA) de <strong>PDF_Tools</strong> nace para ofrecer una alternativa ligera a quienes prefieren no instalar extensiones. La privacidad es absoluta en ambas (el procesamiento es local), pero con una diferencia t칠cnica importante: la extensi칩n funciona completamente <strong>sin conexi칩n</strong> (empaqueta todas las librer칤as), mientras que esta SPA requiere conexi칩n inicial para cargar las bibliotecas necesarias v칤a CDN.
                </p>
                <div class="space-y-3 text-left">
                    <a href="https://www.linkedin.com/in/pfelipm/" target="_blank" class="flex items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 dark:hover:bg-blue-900/50"><i data-lucide="linkedin" class="w-5 h-5 mr-3"></i><span class="font-medium">Perfil de LinkedIn</span></a>
                    <a href="https://github.com/pfelipm/pdf-tools-spa" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors text-gray-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"><i data-lucide="github" class="w-5 h-5 mr-3"></i><span class="font-medium">Repositorio SPA (GitHub)</span></a>
                    <div class="mt-4 pt-4 border-t border-gray-100 text-left dark:border-gray-700">
                        <p class="text-sm text-gray-500 mb-1 dark:text-gray-400">Basado en la extensi칩n de Chrome <a href="https://chromewebstore.google.com/detail/pdftools/amfbkjdnaalliclaenmafeohionnkmoa" target="_blank" class="text-blue-600 hover:underline font-semibold dark:text-blue-400">PDF_Tools</a>.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Resultados -->
    <div id="download-result-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 relative animate-fade-in flex flex-col max-h-[80vh] dark:bg-gray-800">
            <button onclick="document.getElementById('download-result-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 dark:text-white"><i data-lucide="check-circle" class="w-6 h-6 text-green-600 dark:text-green-400"></i> Archivos listos</h3>
            <p class="text-sm text-gray-500 mb-4 dark:text-gray-400">Descarga los archivos individualmente:</p>
            <div id="download-list" class="flex-1 overflow-y-auto space-y-2 custom-scroll p-1"></div>

            <div id="single-file-actions" class="hidden mt-4 pt-4 border-t border-gray-100 flex-col gap-3 dark:border-gray-700">
                <p class="text-xs text-gray-500 text-center uppercase font-bold tracking-wide dark:text-gray-400">Opciones adicionales</p>
                <div class="flex justify-center gap-3">
                    <button id="res-to-org-btn" class="px-3 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-lg text-sm font-medium transition flex items-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i> Organizar
                    </button>
                    <button id="res-to-editor-btn" class="px-3 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-lg text-sm font-medium transition flex items-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="pencil" class="w-4 h-4"></i> Editar
                    </button>
                    <button id="res-to-img-btn" class="px-3 py-2 bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 rounded-lg text-sm font-medium transition flex items-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="images" class="w-4 h-4"></i> A im치genes
                    </button>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-100 text-center dark:border-gray-700">
                <button onclick="document.getElementById('download-result-modal').classList.add('hidden')" class="text-blue-600 hover:underline text-sm font-medium dark:text-blue-400">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal 칄xito Organizar -->
    <div id="organize-success-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative animate-fade-in text-center dark:bg-gray-800">
            <button onclick="document.getElementById('organize-success-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="flex justify-center mb-4">
                <div class="bg-green-100 p-3 rounded-full dark:bg-green-900/30">
                    <i data-lucide="check" class="w-8 h-8 text-green-600 dark:text-green-400"></i>
                </div>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2 dark:text-white">춰PDF Organizado!</h3>
            <p class="text-gray-500 mb-6 text-sm dark:text-gray-400">El archivo se ha procesado correctamente. 쯈u칠 quieres hacer ahora?</p>

            <div class="flex flex-col gap-3">
                <button id="org-success-download" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition flex items-center justify-center gap-2 dark:bg-green-500 dark:hover:bg-green-600">
                    <i data-lucide="download" class="w-5 h-5"></i> Descargar PDF
                </button>
                <div class="flex gap-3">
                    <button id="org-success-editor" class="flex-1 py-2.5 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-xl font-medium transition flex items-center justify-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="pencil" class="w-4 h-4"></i> Editar
                    </button>
                    <button id="org-success-img" class="flex-1 py-2.5 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-xl font-medium transition flex items-center justify-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="images" class="w-4 h-4"></i> A im치genes
                    </button>
                    <button id="org-success-split" class="flex-1 py-2.5 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-xl font-medium transition flex items-center justify-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="scissors" class="w-4 h-4"></i> Dividir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Aplanar PDF -->
    <div id="flatten-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 relative animate-fade-in dark:bg-gray-800">
            <button onclick="document.getElementById('flatten-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="text-center mb-6">
                <div class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400">
                    <i data-lucide="layers" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Aplanar PDF</h3>
                <p class="text-xs text-gray-500 mt-2 px-2 dark:text-gray-400">Convierte las p치ginas en im치genes. El texto oculto o censurado ser치 irrecuperable.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 dark:text-gray-400">Formato Intermedio</label>
                    <div class="flex gap-2">
                        <label class="flex-1 flex items-center justify-center p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-purple-500 has-[:checked]:bg-purple-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-purple-900/30 dark:has-[:checked]:border-purple-400">
                            <input type="radio" name="flatFormat" value="jpeg" checked class="sr-only">
                            <span class="text-sm font-medium dark:text-gray-200">JPG (menor peso)</span>
                        </label>
                        <label class="flex-1 flex items-center justify-center p-2 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-purple-500 has-[:checked]:bg-purple-50 transition dark:border-gray-600 dark:hover:bg-gray-700 dark:has-[:checked]:bg-purple-900/30 dark:has-[:checked]:border-purple-400">
                            <input type="radio" name="flatFormat" value="png" class="sr-only">
                            <span class="text-sm font-medium dark:text-gray-200">PNG (calidad)</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 dark:text-gray-400">Calidad (DPI)</label>
                    <select id="flatDpi" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm outline-none bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="72">72 DPI (pantalla)</option>
                        <option value="150" selected>150 DPI (media)</option>
                        <option value="300">300 DPI (alta)</option>
                    </select>
                </div>

                <button onclick="editorFlatten()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold transition shadow-md flex items-center justify-center gap-2 mt-4 dark:bg-purple-500 dark:hover:bg-purple-600">
                    <i data-lucide="check" class="w-5 h-5"></i> Procesar y Descargar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal 칄xito Editor -->
    <div id="editor-success-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 relative animate-fade-in text-center dark:bg-gray-800">
            <button onclick="document.getElementById('editor-success-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"><i data-lucide="x" class="w-6 h-6"></i></button>
            <div class="flex justify-center mb-4">
                <div class="bg-purple-100 p-3 rounded-full dark:bg-purple-900/30">
                    <i data-lucide="check" class="w-8 h-8 text-purple-600 dark:text-purple-400"></i>
                </div>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2 dark:text-white">춰PDF Editado!</h3>
            <p class="text-gray-500 mb-6 text-sm dark:text-gray-400">El archivo se ha procesado correctamente. 쯈u칠 quieres hacer ahora?</p>

            <div class="flex flex-col gap-3">
                <button id="edt-success-download" class="w-full py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition flex items-center justify-center gap-2 dark:bg-purple-500 dark:hover:bg-purple-600">
                    <i data-lucide="download" class="w-5 h-5"></i> Descargar PDF
                </button>
                <div class="flex gap-3">
                    <button id="edt-success-org" class="flex-1 py-2.5 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-xl font-medium transition flex items-center justify-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i> Organizar
                    </button>
                    <button id="edt-success-img" class="flex-1 py-2.5 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-xl font-medium transition flex items-center justify-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="images" class="w-4 h-4"></i> A im치genes
                    </button>
                    <button id="edt-success-split" class="flex-1 py-2.5 bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-xl font-medium transition flex items-center justify-center gap-2 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-600">
                        <i data-lucide="scissors" class="w-4 h-4"></i> Dividir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Zoom (Lupa Universal) -->
    <div id="zoom-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="relative w-full h-full p-4 flex items-center justify-center" onclick="event.stopPropagation()">
            <button onclick="document.getElementById('zoom-modal').classList.add('hidden')" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white p-2 rounded-full transition z-50">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <div class="max-w-full max-h-full overflow-auto rounded shadow-2xl custom-scroll">
                <canvas id="zoom-canvas" class="block mx-auto"></canvas>
            </div>
        </div>
    </div>

    <!-- Progress & Canvas -->
    <div id="progressModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center dark:bg-gray-800">
            <div class="loader mx-auto mb-6"></div>
            <h3 class="text-lg font-bold text-gray-800 mb-2 dark:text-white">Procesando...</h3>
            <p id="progressText" class="text-gray-500 text-sm mb-4 dark:text-gray-400">Por favor espera</p>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-2 overflow-hidden dark:bg-gray-700"><div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div></div>
        </div>
    </div>
    <canvas id="exportCanvas" class="hidden"></canvas>

    <script>
        // --- THEME LOGIC ---
        const themeToggleBtn = document.getElementById('theme-toggle');

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }

        themeToggleBtn.addEventListener('click', toggleTheme);



        // ==========================================
        // L칍GICA DEL EDITOR (NUEVO M칍DULO)
        // ==========================================
        
        // --- State ---
        const editorState = {
            doc: null,          // PDFLib Doc
            pdfData: null,      // ArrayBuffer
            pdfJsDoc: null,     // PDF.js Doc
            canvas: null,       // Fabric Canvas
            currentPage: 1,
            scale: 1,
            pagesData: {},      // { pageNum: json }
            globalObjects: [],  // Objects with isGlobal: true
            historyUndo: [],    // Undo stack
            historyRedo: [],    // Redo stack
            historyProcessing: false, // Flag to prevent loops
            clipboard: null,    // For copy/paste
            defaults: {         // User Style Preferences
                shape: { fill: 'transparent', stroke: '#ff0000', strokeWidth: 3 },
                text: { fontSize: 24, fill: '#ff0000', fontFamily: 'Arial', fontWeight: 'normal', fontStyle: 'normal', underline: false },
                draw: { width: 5, color: '#ff0000' }
            }
        };

        // --- Init & Upload ---
        document.getElementById('editorInput').addEventListener('change', (e) => loadEditorPdf(e.target.files[0]));
        
        async function loadEditorPdf(file, bytes=null, name=null) {
            if(!file && !bytes) return;
            showProgress('Cargando Editor...', 10);
            try {
                if(file) {
                    editorState.pdfData = await file.arrayBuffer();
                } else if(bytes) {
                    editorState.pdfData = bytes.buffer.slice(0); // Ensure ArrayBuffer
                }

                editorState.pdfJsDoc = await pdfjsLib.getDocument(editorState.pdfData.slice(0)).promise;
                editorState.doc = await PDFDocument.load(editorState.pdfData.slice(0));
                
                // Reset State
                editorState.pagesData = {};
                editorState.globalObjects = [];
                editorState.historyUndo = [];
                editorState.historyRedo = [];
                editorState.currentPage = 1;
                editorState.scale = 1; // Reset scale
                
                // Reset UI Layout
                document.getElementById('canvas-wrapper').style.transform = 'scale(1)';
                document.getElementById('editor-scroll-area').scrollTop = 0;
                document.getElementById('editor-scroll-area').scrollLeft = 0;
                
                // UI Switch
                document.getElementById('editor-upload').classList.add('hidden');
                document.getElementById('editor-workspace').classList.remove('hidden');
                document.getElementById('editor-workspace').classList.add('flex');
                
                // Clean Init Fabric
                if(editorState.canvas) {
                    editorState.canvas.dispose();
                    editorState.canvas = null;
                }
                initFabric();
                setEditorMode('select'); // Always start with selection tool
                
                // Clear properties panel
                document.getElementById('editor-properties').innerHTML = `
                    <div class="text-center text-gray-400 mt-10 text-sm">
                        <i data-lucide="mouse-pointer-click" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p>Selecciona un objeto para editarlo</p>
                    </div>`;
                lucide.createIcons();
                
                await renderEditorSidebar();
                await loadEditorPage(1);
                
            } catch(e) { console.error(e); alert('Error cargando PDF en editor'); }
            finally { hideProgress(); }
        }

        // --- Tools & Actions ---
        let isDrawingShape = false;
        let shapeStart = { x: 0, y: 0 };
        let activeShape = null;

        function createNoisePattern() {
            const patternCanvas = document.createElement('canvas');
            patternCanvas.width = 20; patternCanvas.height = 20;
            const ctx = patternCanvas.getContext('2d');
            for(let i=0; i<20; i+=2) {
                for(let j=0; j<20; j+=2) {
                    ctx.fillStyle = Math.random() > 0.5 ? '#333' : '#ccc';
                    ctx.fillRect(i, j, 2, 2);
                }
            }
            return new fabric.Pattern({ source: patternCanvas, repeat: 'repeat' });
        }

        function initFabric() {
            editorState.canvas = new fabric.Canvas('fabric-canvas', {
                preserveObjectStacking: true,
                selection: true
            });
            
            // Event Listeners
            editorState.canvas.on('selection:created', updateEditorProperties);
            editorState.canvas.on('selection:updated', updateEditorProperties);
            editorState.canvas.on('selection:cleared', () => {
                document.getElementById('editor-properties').innerHTML = `
                    <div class="text-center text-gray-400 mt-10 text-sm">
                        <i data-lucide="mouse-pointer-click" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p>Selecciona un objeto para editarlo</p>
                    </div>`;
                lucide.createIcons();
            });
            editorState.canvas.on('object:added', (e) => {
                if(!e.target.id) e.target.id = crypto.randomUUID();
                saveHistory();
            });
            editorState.canvas.on('object:removed', saveHistory);
            
            // Fix Freehand Drawing Stroke Scaling
            editorState.canvas.on('path:created', (e) => {
                e.path.set('strokeUniform', true);
                saveHistory();
            });

            // Scaling Logic for Patterns (Noise) - Solid fill for performance
            editorState.canvas.on('object:scaling', (e) => {
                const obj = e.target;
                if (obj.isNoise) {
                    obj.set('fill', '#000000');
                }
            });

            // Fix Noise Pattern on Resize End
            editorState.canvas.on('object:modified', (e) => {
                const obj = e.target;
                if (obj.isNoise) {
                    const width = obj.width * obj.scaleX;
                    const height = obj.height * obj.scaleY;
                    obj.set({ width: width, height: height, scaleX: 1, scaleY: 1 });
                    // Force pattern refresh
                    obj.set('fill', createNoisePattern());
                    obj.setCoords();
                    editorState.canvas.requestRenderAll();
                }
                saveHistory();
            });

            // Mouse Events for Click & Drag Creation
            editorState.canvas.on('mouse:down', (o) => {
                if(editorState.mode === 'pixelate') {
                    // Check if clicked on existing object
                    const target = editorState.canvas.findTarget(o.e);
                    if (target) return; // Allow selection/resize

                    isDrawingShape = true;
                    const pointer = editorState.canvas.getPointer(o.e);
                    shapeStart = { x: pointer.x, y: pointer.y };
                    
                    activeShape = new fabric.Rect({
                        left: shapeStart.x, top: shapeStart.y, width: 0, height: 0,
                        fill: createNoisePattern(),
                        isNoise: true,
                        objectCaching: false,
                        originX: 'left', originY: 'top',
                        lockScalingFlip: true,
                        strokeUniform: true, // Fix visual shifts
                        transparentCorners: false, cornerColor: '#3b82f6', cornerSize: 10
                    });
                    
                    editorState.canvas.add(activeShape);
                    editorState.canvas.setActiveObject(activeShape);
                }
            });

            editorState.canvas.on('mouse:move', (o) => {
                if (!isDrawingShape || !activeShape) return;
                const pointer = editorState.canvas.getPointer(o.e);
                
                if(editorState.mode === 'pixelate') {
                    if (shapeStart.x > pointer.x) { activeShape.set({ left: Math.abs(pointer.x) }); }
                    if (shapeStart.y > pointer.y) { activeShape.set({ top: Math.abs(pointer.y) }); }
                    activeShape.set({ width: Math.abs(shapeStart.x - pointer.x) });
                    activeShape.set({ height: Math.abs(shapeStart.y - pointer.y) });
                    editorState.canvas.renderAll();
                }
            });

            editorState.canvas.on('mouse:up', () => {
                if(isDrawingShape) {
                    isDrawingShape = false;
                    activeShape = null;
                    if(editorState.mode === 'pixelate') {
                        // setEditorMode('select'); // Removed to keep tool active
                        saveHistory();
                    }
                }
            });
            
            // Keyboard Shortcuts
            window.addEventListener('keydown', handleEditorKeys);
        }

        // --- Sidebar & Navigation ---
        async function renderEditorSidebar() {
            const container = document.getElementById('editor-sidebar');
            container.innerHTML = '';
            
            for(let i=1; i<=editorState.pdfJsDoc.numPages; i++) {
                const div = document.createElement('div');
                div.className = `page-thumbnail p-2 border-2 border-transparent rounded cursor-pointer hover:bg-gray-200 transition bg-white ${i===1?'active':''} dark:bg-gray-700 dark:hover:bg-gray-600`;
                div.id = `thumb-${i}`;
                div.innerHTML = `
                    <div class="h-32 flex items-center justify-center bg-gray-100 overflow-hidden mb-1 rounded dark:bg-gray-800">
                        <canvas id="thumb-cvs-${i}" class="max-w-full max-h-full"></canvas>
                    </div>
                    <div class="text-xs text-center font-medium text-gray-500 dark:text-gray-400">P치g ${i}</div>
                `;
                div.onclick = () => loadEditorPage(i);
                container.appendChild(div);
                
                // Lazy render thumb
                editorState.pdfJsDoc.getPage(i).then(page => {
                    const cvs = document.getElementById(`thumb-cvs-${i}`);
                    const viewport = page.getViewport({ scale: 0.2 });
                    cvs.width = viewport.width; cvs.height = viewport.height;
                    page.render({ canvasContext: cvs.getContext('2d'), viewport: viewport });
                });
            }
        }

        async function loadEditorPage(pageNum) {
            // Optimization: Don't reload if clicking current page
            if (editorState.currentPage === pageNum && editorState.canvas.getObjects().length > 0) return;

            editorState.historyProcessing = true; // Block history events during transition

            // 1. Save PREVIOUS page state (if valid)
            if(editorState.currentPage !== pageNum && editorState.canvas) {
                // Only save if we are navigating AWAY from a loaded page
                const json = editorState.canvas.toJSON(['id', 'isGlobal', 'isNoise', 'isPageNumber', 'textTemplate', 'startPage', 'startValue']);
                editorState.pagesData[editorState.currentPage] = json;
                // Update globals
                editorState.globalObjects = json.objects.filter(o => o.isGlobal);
            }

            // 2. Update UI
            document.querySelectorAll('.page-thumbnail').forEach(el => el.classList.remove('active'));
            document.getElementById(`thumb-${pageNum}`).classList.add('active');
            editorState.currentPage = pageNum;
            
            // Reset History for new page
            editorState.historyUndo = [];
            editorState.historyRedo = [];

            // 3. Prepare Dimensions & Zoom (Pre-calculation to avoid glitch)
            editorState.canvas.clear();
            const page = await editorState.pdfJsDoc.getPage(pageNum);
            
            // Base resolution (High quality)
            const baseViewport = page.getViewport({ scale: 1.5 }); 
            editorState.baseWidth = baseViewport.width;
            editorState.baseHeight = baseViewport.height;

            // Calculate Fit-to-Page Scale IMMEDIATELY
            const container = document.getElementById('editor-scroll-area');
            const cWidth = container.clientWidth || window.innerWidth;
            const cHeight = container.clientHeight || window.innerHeight;
            
            const wRatio = (cWidth - 80) / editorState.baseWidth;
            const hRatio = (cHeight - 80) / editorState.baseHeight;
            editorState.scale = Math.min(1.5, Math.max(0.1, Math.min(wRatio, hRatio)));

            // Apply calculated dimensions
            const w = editorState.baseWidth * editorState.scale;
            const h = editorState.baseHeight * editorState.scale;

            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.style.width = `${w}px`;
            wrapper.style.height = `${h}px`;
            wrapper.style.transform = 'none';

            editorState.canvas.setDimensions({ width: w, height: h });
            editorState.canvas.setZoom(editorState.scale);
            document.getElementById('editor-zoom-display').innerText = `${Math.round(editorState.scale*100)}%`;

            // 4. Render Background (PDF.js) - Single Pass at correct scale
            const bgCvs = document.getElementById('pdf-render');
            bgCvs.width = w; bgCvs.height = h;
            
            const renderViewport = page.getViewport({ scale: 1.5 * editorState.scale });
            await page.render({ canvasContext: bgCvs.getContext('2d'), viewport: renderViewport }).promise;

            // 5. Load Objects
            const savedJson = editorState.pagesData[pageNum];
            
            // Filter out globals from savedJson
            let objectsToLoad = savedJson ? savedJson.objects.filter(o => !o.isGlobal) : [];
            const currentIds = new Set(objectsToLoad.map(o => o.id));
            
            editorState.globalObjects.forEach(gObj => {
                if(!currentIds.has(gObj.id)) objectsToLoad.push(gObj);
            });

            if(objectsToLoad.length > 0) {
                await new Promise(resolve => {
                    fabric.util.enlivenObjects(objectsToLoad, (objs) => {
                        objs.forEach(o => {
                            // Dynamic Page Number Logic
                            if(o.isPageNumber && o.textTemplate) {
                                const t = editorState.pdfJsDoc.numPages;
                                const startPage = o.startPage || 1;
                                
                                if(pageNum < startPage) {
                                    o.set('opacity', 0.5); // Ghost
                                } else {
                                    o.set('opacity', 1);
                                    const n = (pageNum - startPage) + (o.startValue || 1);
                                    o.set('text', o.textTemplate.replace('{n}', n).replace('{t}', t));
                                    o.bringToFront(); 
                                }
                            }
                            editorState.canvas.add(o);
                        });
                        editorState.canvas.renderAll();
                        resolve();
                    });
                });
            }
            
            // Force update page numbers text with Offset
            editorState.canvas.getObjects().forEach(o => {
                if(o.isPageNumber && o.textTemplate) {
                    const t = editorState.pdfJsDoc.numPages;
                    const startPage = o.startPage || 1;
                    
                    if(pageNum < startPage) {
                        o.set('opacity', 0.5); // Ghost mode
                        o.set('text', o.textTemplate); // Show template as placeholder
                    } else {
                        o.set('opacity', 1);
                        const n = (pageNum - startPage) + (o.startValue || 1);
                        o.set('text', o.textTemplate.replace('{n}', n).replace('{t}', t));
                        o.bringToFront(); 
                    }
                }
            });
            editorState.canvas.renderAll();
            
            editorState.historyProcessing = false;
            saveHistory(); // Save baseline state
            // No setTimeout needed
        }

        // --- Tools & Actions ---
        function setEditorMode(mode) {
            editorState.mode = mode; // Store mode
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active', 'bg-purple-50', 'text-purple-600', 'dark:bg-purple-900/30', 'dark:text-purple-300'));
            
            editorState.canvas.isDrawingMode = (mode === 'draw');
            
            if(mode === 'draw') {
                const defaults = editorState.defaults.draw;
                editorState.canvas.freeDrawingBrush.width = defaults.width;
                editorState.canvas.freeDrawingBrush.color = defaults.color;
                document.getElementById('tool-draw').classList.add('active', 'bg-purple-50', 'text-purple-600', 'dark:bg-purple-900/30', 'dark:text-purple-300');
                renderBrushProperties(); // Show brush settings immediately
            } else if (mode === 'pixelate') {
                editorState.canvas.defaultCursor = 'crosshair';
                editorState.canvas.selection = false; // Disable group selection while drawing
                document.getElementById('tool-pixelate').classList.add('active', 'bg-purple-50', 'text-purple-600', 'dark:bg-purple-900/30', 'dark:text-purple-300');
            } else {
                editorState.canvas.defaultCursor = 'default';
                editorState.canvas.selection = true;
                document.getElementById('tool-select').classList.add('active', 'bg-purple-50', 'text-purple-600', 'dark:bg-purple-900/30', 'dark:text-purple-300');
            }
        }
        function toggleDrawMode() {
            setEditorMode(editorState.canvas.isDrawingMode ? 'select' : 'draw');
        }

        function addText() {
            const defaults = editorState.defaults.text;
            const text = new fabric.IText('Texto', {
                left: 100, top: 100, 
                fontSize: defaults.fontSize, 
                fill: defaults.fill,
                fontFamily: defaults.fontFamily,
                fontWeight: defaults.fontWeight,
                fontStyle: defaults.fontStyle,
                underline: defaults.underline
            });
            editorState.canvas.add(text);
            editorState.canvas.setActiveObject(text);
            setEditorMode('select');
        }

        function handleAddImage(input) {
            const file = input.files[0];
            if(!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                fabric.Image.fromURL(e.target.result, (img) => {
                    // Smart Scaling: Max 50% of canvas width
                    const maxWidth = editorState.canvas.getWidth() * 0.5;
                    const scale = img.width > maxWidth ? maxWidth / img.width : 1;
                    
                    img.set({
                        left: 100, top: 100,
                        scaleX: scale, scaleY: scale
                    });
                    
                    editorState.canvas.add(img);
                    editorState.canvas.setActiveObject(img);
                    setEditorMode('select');
                    saveHistory();
                    input.value = ''; // Reset for next use
                });
            };
            reader.readAsDataURL(file);
        }

        function addPageNumber() {
            const canvasCenter = editorState.canvas.getWidth() / 2;
            const canvasBottom = editorState.canvas.getHeight() - 50;
            
            const text = new fabric.Text('P치g {n} de {t}', {
                left: canvasCenter, 
                top: canvasBottom, 
                fontSize: 18, 
                fill: '#000000',
                fontFamily: 'Arial',
                originX: 'center',
                isPageNumber: true,
                isGlobal: true,
                startPage: 1, // Physical page where numbering starts
                startValue: 1, // The number to display on that page
                textTemplate: 'P치g {n} de {t}', // Store the template
                lockScalingX: true, // Lock scaling to avoid distortion, font size control is enough
                lockScalingY: true
            });
            
            // Initial Render replacement
            const n = editorState.currentPage;
            const t = editorState.pdfJsDoc.numPages;
            text.text = text.textTemplate.replace('{n}', n).replace('{t}', t);

            editorState.canvas.add(text);
            editorState.canvas.setActiveObject(text);
            setEditorMode('select');
        }

        function renderBrushProperties() {
            const brush = editorState.canvas.freeDrawingBrush;
            const color = brush.color;
            const width = brush.width;
            
            const panel = document.getElementById('editor-properties');
            panel.innerHTML = `
                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Herramienta Dibujo</label>
                    
                    <div class="space-y-2">
                         <div class="flex items-center justify-between">
                            <span class="text-sm dark:text-gray-300">Grosor</span>
                         </div>
                         
                         <div class="flex items-center gap-2">
                            <input type="range" min="1" max="50" value="${width}" oninput="updateBrushWidth(parseInt(this.value))" class="flex-1">
                            <span id="brush-width-val" class="text-xs w-6 text-center font-mono dark:text-gray-400">${width}</span>
                         </div>
                         
                         <div class="flex items-center justify-between mt-1">
                            <span class="text-xs text-gray-400">Color del trazo</span>
                            <input type="color" value="${color}" oninput="updateBrushColor(this.value)" class="w-6 h-6 rounded cursor-pointer border border-gray-200 dark:border-gray-600">
                         </div>
                    </div>
                </div><hr class="dark:border-gray-700">`;
            lucide.createIcons();
        }

        function updateBrushWidth(val) {
            editorState.canvas.freeDrawingBrush.width = val;
            editorState.defaults.draw.width = val;
            editorState.defaults.shape.strokeWidth = val; // Sync to shapes
            document.getElementById('brush-width-val').innerText = val;
        }

        function updateBrushColor(val) {
            editorState.canvas.freeDrawingBrush.color = val;
            editorState.defaults.draw.color = val;
            editorState.defaults.shape.stroke = val; // Sync to shapes
        }

        function addShape(type) {
            let shape;
            const defaults = editorState.defaults.shape;
            const props = { 
                left: 150, top: 150, 
                fill: defaults.fill, 
                stroke: defaults.stroke, 
                strokeWidth: defaults.strokeWidth,
                strokeUniform: true // Fix border scaling
            };
            
            if(type === 'rect') shape = new fabric.Rect({ ...props, width: 100, height: 100 });
            else if(type === 'circle') shape = new fabric.Circle({ ...props, radius: 50 });
            else if(type === 'triangle') shape = new fabric.Triangle({ ...props, width: 100, height: 100 });
            else if(type === 'star') {
                const points = [{x:0, y:-50},{x:14, y:-20},{x:47, y:-15},{x:23, y:7},{x:29, y:40},{x:0, y:25},{x:-29, y:40},{x:-23, y:7},{x:-47, y:-15},{x:-14, y:-20}];
                shape = new fabric.Polygon(points, { ...props });
            }
            else if(type === 'line') shape = new fabric.Line([50, 50, 200, 50], { ...props, strokeWidth: defaults.strokeWidth || 5 });
            else if(type === 'arrow') {
                // SVG Arrow Path
                const path = "M 0 0 L 100 0 M 100 0 L 85 -10 M 100 0 L 85 10";
                shape = new fabric.Path(path, { ...props, fill: null, strokeWidth: defaults.strokeWidth || 5, strokeLineCap: 'round', strokeLineJoin: 'round' });
            }
            
            editorState.canvas.add(shape);
            editorState.canvas.setActiveObject(shape);
            setEditorMode('select');
        }
        function addIcon(type) {
             const text = type === 'smile' ? '游뗵' : '游뗴';
             const icon = new fabric.IText(text, { left: 200, top: 200, fontSize: 60 });
             editorState.canvas.add(icon);
             editorState.canvas.setActiveObject(icon);
             setEditorMode('select');
        }

        // --- Properties Panel ---
        function updateEditorProperties() {
            const obj = editorState.canvas.getActiveObject();
            if(!obj) return;
            
            const panel = document.getElementById('editor-properties');
            let html = '';
            
            // 0. Multiple Selection - Simplified Panel
            if(obj.type === 'activeSelection') {
                html += `
                <div class="space-y-3">
                     <label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Selecci칩n M칰ltiple</label>
                     <p class="text-xs text-gray-400 mb-2">${obj._objects.length} elementos</p>
                     
                     <div>
                        <span class="text-sm mb-1 block dark:text-gray-300">Opacidad Conjunta</span>
                        <input type="range" min="0" max="1" step="0.1" value="1" oninput="updateActiveObj('opacity', parseFloat(this.value))" class="w-full">
                     </div>

                     <label class="flex items-center gap-2 cursor-pointer mt-2">
                        <input type="checkbox" onchange="updateActiveObj('isGlobal', this.checked)" class="dark:bg-gray-700">
                        <span class="text-sm dark:text-gray-300">Repetir en todas</span>
                     </label>
                     
                     <div class="flex gap-2 mt-2">
                        <button onclick="editorOrder('front')" class="flex-1 py-1 text-xs border rounded hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">Al frente</button>
                        <button onclick="editorOrder('back')" class="flex-1 py-1 text-xs border rounded hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">Al fondo</button>
                     </div>

                     <button onclick="editorDelete()" class="w-full py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm font-medium flex items-center justify-center gap-2 mt-4 dark:bg-red-900/20 dark:hover:bg-red-900/40 dark:text-red-400">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Eliminar
                     </button>
                </div>`;
                panel.innerHTML = html;
                lucide.createIcons();
                return;
            }
            
            // 1. Text Props
            if(obj.type === 'i-text' || obj.type === 'text') {
                const isPageNum = obj.isPageNumber;
                
                html += `
                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">${isPageNum ? 'Patr칩n de Numeraci칩n' : 'Texto'}</label>
                    
                    ${isPageNum ? `
                    <div class="flex gap-1 mb-2">
                        <button onclick="updatePageNumTemplate('{n}')" class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300"><b>{n}</b> P치g</button>
                        <button onclick="updatePageNumTemplate('{t}')" class="px-2 py-1 text-xs bg-gray-100 rounded hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300"><b>{t}</b> Total</button>
                    </div>
                    <input type="text" value="${obj.textTemplate || obj.text}" oninput="updatePageNumTemplate(this.value, true)" class="w-full text-sm border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white mb-2">
                    
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-400">Alineaci칩n (Pie)</span>
                        <div class="flex gap-1">
                            <button onclick="alignPageNum('left')" class="p-1.5 border rounded hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700" title="Izquierda"><i data-lucide="align-left" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i></button>
                            <button onclick="alignPageNum('center')" class="p-1.5 border rounded hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700" title="Centro"><i data-lucide="align-center" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i></button>
                            <button onclick="alignPageNum('right')" class="p-1.5 border rounded hover:bg-gray-50 dark:border-gray-600 dark:hover:bg-gray-700" title="Derecha"><i data-lucide="align-right" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i></button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-400">Empezar en p치g.</span>
                        <input type="number" min="1" max="${editorState.pdfJsDoc.numPages}" value="${obj.startPage||1}" oninput="updatePageNumSettings('startPage', this.value)" class="w-14 text-sm border p-1 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-gray-400">Con el n칰mero</span>
                        <input type="number" min="1" value="${obj.startValue||1}" oninput="updatePageNumSettings('startValue', this.value)" class="w-14 text-sm border p-1 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    ` : `
                    <textarea oninput="updateActiveObj('text', this.value)" class="w-full text-sm border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="2">${obj.text}</textarea>
                    `}
                    
                    <div>
                        <label class="text-xs text-gray-400 mb-1 block">Fuente</label>
                        <select onchange="updateActiveObj('fontFamily', this.value)" class="w-full text-sm border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="Times New Roman" ${obj.fontFamily==='Times New Roman'?'selected':''}>Times New Roman</option>
                            <option value="Arial" ${obj.fontFamily==='Arial'?'selected':''}>Arial</option>
                            <option value="Courier New" ${obj.fontFamily==='Courier New'?'selected':''}>Courier New</option>
                            <option value="Georgia" ${obj.fontFamily==='Georgia'?'selected':''}>Georgia</option>
                            <option value="Verdana" ${obj.fontFamily==='Verdana'?'selected':''}>Verdana</option>
                        </select>
                    </div>

                    <div class="flex gap-2 items-center">
                        <div class="flex-1">
                             <label class="text-xs text-gray-400 mb-1 block">Tama침o</label>
                             <input type="number" min="1" max="200" value="${obj.fontSize}" onchange="updateActiveObj('fontSize', Math.max(1, Math.min(200, parseInt(this.value))))" class="w-full text-sm border p-2 rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                             <label class="text-xs text-gray-400 mb-1 block">Color</label>
                             <input type="color" value="${obj.fill}" oninput="updateActiveObj('fill', this.value)" class="w-9 h-9 rounded cursor-pointer border border-gray-200 dark:border-gray-600">
                        </div>
                    </div>
                    
                    <div class="flex gap-1 justify-between">
                        <button onclick="toggleStyle('fontWeight', 'bold')" class="flex-1 p-2 border rounded ${obj.fontWeight==='bold'?'bg-gray-200 dark:bg-gray-600':''} dark:border-gray-600 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700"><b>B</b></button>
                        <button onclick="toggleStyle('fontStyle', 'italic')" class="flex-1 p-2 border rounded ${obj.fontStyle==='italic'?'bg-gray-200 dark:bg-gray-600':''} dark:border-gray-600 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700"><i>I</i></button>
                        <button onclick="toggleStyle('underline', true)" class="flex-1 p-2 border rounded ${obj.underline?'bg-gray-200 dark:bg-gray-600':''} dark:border-gray-600 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700"><u>U</u></button>
                    </div>
                </div><hr class="dark:border-gray-700">`;
            }
            
            // 2. Shape/Path Props - Skip for Noise/Pixelate/Text/Image
            // Logic: Line & Path (Draw) -> No Fill option, Border is Thickness.
            //        Rect & Circle -> Fill option, Border is Stroke.
            if(!obj.isNoise && obj.type !== 'i-text' && obj.type !== 'text' && obj.type !== 'image') {
                const isLineOrPath = obj.type === 'line' || obj.type === 'path';
                
                html += `
                <div class="space-y-3">
                    <label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">Estilo</label>
                    
                    ${!isLineOrPath ? `
                    <div class="flex items-center justify-between">
                         <span class="text-sm dark:text-gray-300">Relleno</span>
                         <div class="flex items-center gap-2">
                            <input type="checkbox" ${obj.fill!=='transparent'?'checked':''} onchange="const val = this.checked ? '#cccccc' : 'transparent'; updateActiveObj('fill', val); const col = this.nextElementSibling; col.value = val; col.disabled = !this.checked;" class="dark:bg-gray-700 w-4 h-4">
                            <input type="color" value="${obj.fill==='transparent'?'#cccccc':obj.fill}" oninput="updateActiveObj('fill', this.value)" class="w-6 h-6 rounded cursor-pointer border border-gray-200 dark:border-gray-600" ${obj.fill==='transparent'?'disabled':''}>
                         </div>
                    </div>` : ''}

                    <div class="space-y-2">
                         <div class="flex items-center justify-between">
                            <span class="text-sm dark:text-gray-300">${isLineOrPath ? 'Grosor' : 'Borde'}</span>
                            ${!isLineOrPath ? `
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" ${obj.strokeWidth > 0 ? 'checked' : ''} onchange="updateActiveObj('strokeWidth', this.checked ? 1 : 0)" class="w-3 h-3 dark:bg-gray-700">
                                <span class="text-xs text-gray-400">Activo</span>
                            </label>` : ''}
                         </div>
                         
                         <div class="flex items-center gap-2">
                            <input type="range" min="1" max="50" value="${obj.strokeWidth===0 ? 1 : obj.strokeWidth}" oninput="updateActiveObj('strokeWidth', parseInt(this.value))" class="flex-1" ${!isLineOrPath && obj.strokeWidth===0 ? 'disabled' : ''}>
                            <span class="text-xs w-6 text-center font-mono dark:text-gray-400">${obj.strokeWidth}</span>
                         </div>
                         
                         <div class="flex items-center justify-between mt-1">
                            <span class="text-xs text-gray-400">Color trazado</span>
                            <input type="color" value="${obj.stroke}" oninput="updateActiveObj('stroke', this.value)" class="w-6 h-6 rounded cursor-pointer border border-gray-200 dark:border-gray-600">
                         </div>
                    </div>
                </div><hr class="dark:border-gray-700">`;
            }

            // 3. Common Props
            html += `
            <div class="space-y-3">
                 <label class="text-xs font-bold text-gray-500 uppercase dark:text-gray-400">General</label>
                 
                 ${!obj.isNoise ? `
                 <div>
                    <span class="text-sm mb-1 block dark:text-gray-300">Opacidad</span>
                    <input type="range" min="0" max="1" step="0.1" value="${obj.opacity}" oninput="updateActiveObj('opacity', parseFloat(this.value))" class="w-full">
                 </div>
                 
                 <div class="flex gap-2">
                    <button onclick="editorOrder('front')" class="flex-1 py-1 text-xs border rounded hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">Al frente</button>
                    <button onclick="editorOrder('back')" class="flex-1 py-1 text-xs border rounded hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">Al fondo</button>
                 </div>` : ''}

                 <label class="flex items-center gap-2 cursor-pointer mt-2">
                    <input type="checkbox" ${obj.isGlobal?'checked':''} ${obj.isPageNumber ? 'disabled' : ''} onchange="updateActiveObj('isGlobal', this.checked)" class="dark:bg-gray-700 disabled:opacity-50">
                    <span class="text-sm dark:text-gray-300 ${obj.isPageNumber ? 'opacity-50' : ''}">Repetir en todas</span>
                 </label>
                 
                 <button onclick="editorDelete()" class="w-full py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 text-sm font-medium flex items-center justify-center gap-2 mt-2 dark:bg-red-900/20 dark:hover:bg-red-900/40 dark:text-red-400">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Eliminar
                 </button>
            </div>`;
            
            panel.innerHTML = html;
            lucide.createIcons();
        }

        function updateActiveObj(prop, val) {
            const obj = editorState.canvas.getActiveObject();
            if(obj) {
                if(obj.type === 'activeSelection') {
                    obj.getObjects().forEach(o => {
                        o.set(prop, val);
                    });
                } else {
                    obj.set(prop, val);
                    
                    // Update Defaults based on type
                    if (obj.type === 'i-text' || obj.type === 'text') {
                        if (prop in editorState.defaults.text) editorState.defaults.text[prop] = val;
                    } else if (!obj.isNoise && obj.type !== 'image') {
                        // Sync Shape Defaults
                        if (prop in editorState.defaults.shape) editorState.defaults.shape[prop] = val;
                        
                        // Sync Drawing Defaults & Brush if applicable
                        if (prop === 'stroke') {
                            editorState.defaults.draw.color = val;
                            editorState.canvas.freeDrawingBrush.color = val;
                        }
                        if (prop === 'strokeWidth') {
                            editorState.defaults.draw.width = val;
                            editorState.canvas.freeDrawingBrush.width = val;
                        }
                    }
                }
                editorState.canvas.requestRenderAll();
                saveHistory();
            }
        }

        function updatePageNumTemplate(val, isFullText = false) {
            const obj = editorState.canvas.getActiveObject();
            if (!obj || !obj.isPageNumber) return;

            let newTemplate = val;
            if (val === null) newTemplate = obj.textTemplate; // Use existing
            else if (!isFullText) {
                newTemplate = (obj.textTemplate || '') + ' ' + val; 
            }

            obj.set('textTemplate', newTemplate);
            
            // Render logic
            const currentRealPage = editorState.currentPage;
            const startPage = obj.startPage || 1;
            
            if (currentRealPage < startPage) {
                obj.set('opacity', 0.5); // Ghost mode
                obj.set('text', newTemplate); // Show raw template
            } else {
                obj.set('opacity', 1);
                const n = (currentRealPage - startPage) + (obj.startValue || 1);
                const t = editorState.pdfJsDoc.numPages;
                obj.set('text', newTemplate.replace('{n}', n).replace('{t}', t));
            }
            
            if(currentRealPage >= startPage) obj.bringToFront();
            
            editorState.canvas.requestRenderAll();
            saveHistory();
            
            if(!isFullText) updateEditorProperties(); 
        }

        function alignPageNum(align) {
            const obj = editorState.canvas.getActiveObject();
            if (!obj || !obj.isPageNumber) return;
            
            const w = editorState.canvas.getWidth();
            const h = editorState.canvas.getHeight();
            const margin = 50;
            
            let left = w / 2;
            if(align === 'left') left = margin;
            if(align === 'right') left = w - margin;
            
            obj.set({
                left: left,
                top: h - margin,
                originX: align,
                originY: 'bottom'
            });
            obj.setCoords();
            editorState.canvas.requestRenderAll();
            saveHistory();
        }

        function updatePageNumSettings(prop, val) {
            const obj = editorState.canvas.getActiveObject();
            if(!obj || !obj.isPageNumber) return;
            
            const num = parseInt(val);
            if(isNaN(num)) return; 
            
            obj.set(prop, num);
            updatePageNumTemplate(null, true); // Refresh
        }

        function toggleStyle(prop, val) {
            const obj = editorState.canvas.getActiveObject();
            if(obj) {
                // If val is boolean (underline) toggle it. If string (bold), check current.
                let newVal;
                if(typeof val === 'boolean') newVal = !obj[prop];
                else newVal = (obj[prop] === val ? 'normal' : val);
                
                obj.set(prop, newVal);
                
                // Update Defaults
                if (obj.type === 'i-text' || obj.type === 'text') {
                     if (prop in editorState.defaults.text) editorState.defaults.text[prop] = newVal;
                }
                
                editorState.canvas.requestRenderAll();
                saveHistory();
                updateEditorProperties(); // Refresh buttons
            }
        }
        function editorOrder(dir) {
            const obj = editorState.canvas.getActiveObject();
            if(obj) {
                if(dir === 'front') editorState.canvas.bringToFront(obj);
                else editorState.canvas.sendToBack(obj);
                editorState.canvas.requestRenderAll();
                saveHistory();
            }
        }
        function editorDelete() {
            const list = editorState.canvas.getActiveObjects();
            if(list.length) {
                editorState.canvas.discardActiveObject();
                list.forEach(o => {
                    editorState.canvas.remove(o);
                    // Remove from globals if present
                    if(o.isGlobal) {
                        editorState.globalObjects = editorState.globalObjects.filter(g => g.id !== o.id);
                    }
                });
                editorState.canvas.requestRenderAll();
                saveHistory();
            }
        }

        // --- Helper Logic (Zoom, Keys, Save) ---
        async function applyEditorZoom() {
            const w = editorState.baseWidth * editorState.scale;
            const h = editorState.baseHeight * editorState.scale;
            
            // 1. Resize Wrapper
            const wrapper = document.getElementById('canvas-wrapper');
            wrapper.style.width = `${w}px`;
            wrapper.style.height = `${h}px`;
            
            // 2. Resize & Zoom Fabric
            editorState.canvas.setDimensions({ width: w, height: h });
            editorState.canvas.setZoom(editorState.scale);
            
            // 3. Re-render PDF Background
            const page = await editorState.pdfJsDoc.getPage(editorState.currentPage);
            const viewport = page.getViewport({ scale: 1.5 * editorState.scale });
            
            const bgCvs = document.getElementById('pdf-render');
            bgCvs.width = w; bgCvs.height = h;
            await page.render({ canvasContext: bgCvs.getContext('2d'), viewport: viewport }).promise;
            
            document.getElementById('editor-zoom-display').innerText = `${Math.round(editorState.scale*100)}%`;
        }

        function editorZoom(delta) {
            editorState.scale = Math.max(0.1, Math.min(5, editorState.scale + delta));
            applyEditorZoom();
        }
        
        function editorFitPage() {
            const container = document.getElementById('editor-scroll-area');
            const wRatio = (container.clientWidth - 80) / editorState.baseWidth;
            const hRatio = (container.clientHeight - 80) / editorState.baseHeight;
            editorState.scale = Math.min(1.5, Math.max(0.1, Math.min(wRatio, hRatio)));
            applyEditorZoom();
        }
        function saveHistory() {
            if(editorState.historyProcessing) return;
            if(editorState.historyUndo.length > 20) editorState.historyUndo.shift(); // Limit
            editorState.historyUndo.push(JSON.stringify(editorState.canvas.toJSON(['id','isGlobal','isNoise', 'isPageNumber', 'textTemplate', 'startPage', 'startValue'])));
            editorState.historyRedo = []; // Clear redo on new action
        }
        
        function editorUndo() {
            if(editorState.historyProcessing || editorState.historyUndo.length <= 1) return;
            
            editorState.historyProcessing = true;
            editorState.historyRedo.push(editorState.historyUndo.pop()); // Move current to Redo
            const prevState = editorState.historyUndo[editorState.historyUndo.length - 1];
            
            editorState.canvas.loadFromJSON(JSON.parse(prevState), () => {
                editorState.canvas.renderAll();
                editorState.historyProcessing = false;
                updateEditorProperties();
            });
        }

        function editorRedo() {
            if(editorState.historyProcessing || editorState.historyRedo.length === 0) return;
            
            editorState.historyProcessing = true;
            const nextState = editorState.historyRedo.pop();
            editorState.historyUndo.push(nextState); // Move back to Undo
            
            editorState.canvas.loadFromJSON(JSON.parse(nextState), () => {
                editorState.canvas.renderAll();
                editorState.historyProcessing = false;
                updateEditorProperties();
            });
        }

        function handleEditorKeys(e) {
            if(document.getElementById('content-editor').classList.contains('active')) {
                // Undo / Redo
                if(e.ctrlKey && e.key === 'z') { e.preventDefault(); editorUndo(); }
                if(e.ctrlKey && e.key === 'y') { e.preventDefault(); editorRedo(); }

                // Delete
                if(e.key === 'Delete') editorDelete();
                
                // Copy (Ctrl+C)
                if(e.ctrlKey && e.key === 'c') {
                    const obj = editorState.canvas.getActiveObject();
                    if(obj) {
                        obj.clone(cloned => editorState.clipboard = cloned);
                    }
                }
                // Paste (Ctrl+V)
                if(e.ctrlKey && e.key === 'v' && editorState.clipboard) {
                    editorState.clipboard.clone(cloned => {
                        editorState.canvas.discardActiveObject();
                        cloned.set({
                            left: cloned.left + 10,
                            top: cloned.top + 10,
                            evented: true, id: crypto.randomUUID()
                        });
                        if (cloned.type === 'activeSelection') {
                            cloned.canvas = editorState.canvas;
                            cloned.forEachObject(o => editorState.canvas.add(o));
                            cloned.setCoords();
                        } else {
                            editorState.canvas.add(cloned);
                        }
                        editorState.canvas.setActiveObject(cloned);
                        editorState.canvas.requestRenderAll();
                        saveHistory();
                    });
                }
                // Duplicate (Ctrl+D)
                if(e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    const obj = editorState.canvas.getActiveObject();
                    if(obj) {
                        obj.clone(cloned => {
                            editorState.canvas.discardActiveObject();
                            cloned.set({ left: obj.left + 10, top: obj.top + 10, id: crypto.randomUUID() });
                            editorState.canvas.add(cloned);
                            editorState.canvas.setActiveObject(cloned);
                            editorState.canvas.requestRenderAll();
                            saveHistory();
                        });
                    }
                }
                // Nudge (Arrows)
                if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
                    const obj = editorState.canvas.getActiveObject();
                    if(obj) {
                        e.preventDefault();
                        const step = e.shiftKey ? 10 : 1;
                        if(e.key==='ArrowUp') obj.top -= step;
                        if(e.key==='ArrowDown') obj.top += step;
                        if(e.key==='ArrowLeft') obj.left -= step;
                        if(e.key==='ArrowRight') obj.left += step;
                        obj.setCoords();
                        editorState.canvas.requestRenderAll();
                    }
                }
            }
        }

        function openFlattenModal() {
            document.getElementById('flatten-modal').classList.remove('hidden');
        }

        async function generateEditedPdfBytes(progressCallback) {
            // Save current page state first
            if(editorState.canvas.getObjects().length > 0) {
                 editorState.pagesData[editorState.currentPage] = editorState.canvas.toJSON(['id','isGlobal','isNoise', 'isPageNumber', 'textTemplate', 'startPage', 'startValue']);
            }

            const tempCanvas = document.createElement('canvas');
            const tempFabric = new fabric.Canvas(tempCanvas);
            
            const newPdf = await PDFDocument.create();
            const srcPdf = await PDFDocument.load(editorState.pdfData);
            const total = editorState.pdfJsDoc.numPages;
            
            for(let i=1; i<=total; i++) {
                if(progressCallback) progressCallback(i, total);
                
                const json = editorState.pagesData[i];
                let objects = json ? json.objects : [];
                
                const currentIds = new Set(objects.map(o=>o.id));
                editorState.globalObjects.forEach(g => {
                    if(!currentIds.has(g.id)) objects.push(g);
                });
                
                const [copiedPage] = await newPdf.copyPages(srcPdf, [i-1]);
                
                if(objects.length > 0) {
                    const page = await editorState.pdfJsDoc.getPage(i);
                    const vp = page.getViewport({scale: 2.0});
                    tempFabric.setWidth(vp.width);
                    tempFabric.setHeight(vp.height);
                    tempFabric.clear();
                    
                    const scaleFactor = 2.0 / 1.5;

                    await new Promise(resolve => {
                         fabric.util.enlivenObjects(objects, (objs) => {
                             objs.forEach(o => {
                                 // Dynamic Page Number Logic for Export
                                 if(o.isPageNumber && o.textTemplate) {
                                     const startPage = o.startPage || 1;
                                     if (i < startPage) {
                                         // Skip rendering this object for this page
                                         return; 
                                     }
                                     const n = (i - startPage) + (o.startValue || 1);
                                     o.text = o.textTemplate.replace('{n}', n).replace('{t}', total);
                                 }
                                 
                                 o.scaleX *= scaleFactor;
                                 o.scaleY *= scaleFactor;
                                 o.left *= scaleFactor;
                                 o.top *= scaleFactor;
                                 tempFabric.add(o);
                             });
                             tempFabric.renderAll();
                             resolve();
                         });
                    });
                    
                    const pngData = tempFabric.toDataURL({ format: 'png', multiplier: 1 });
                    const pngImage = await newPdf.embedPng(pngData);
                    
                    copiedPage.drawImage(pngImage, {
                        x: 0, y: 0, width: copiedPage.getWidth(), height: copiedPage.getHeight()
                    });
                }
                newPdf.addPage(copiedPage);
            }
            return await newPdf.save();
        }

        async function editorSave() {
            showProgress('Generando PDF...', 0);
            try {
                const pdfBytes = await generateEditedPdfBytes((i, total) => {
                    showProgress(`Procesando p치g ${i}/${total}...`, (i/total)*90);
                });
                
                const blob = new Blob([pdfBytes], {type: 'application/pdf'});
                
                // Show Success Modal
                const modal = document.getElementById('editor-success-modal');
                document.getElementById('edt-success-download').onclick = () => saveBlob(blob, 'editado.pdf');
                document.getElementById('edt-success-org').onclick = () => { modal.classList.add('hidden'); switchTab('organize'); loadOrganizeFromBytes(new Uint8Array(pdfBytes), 'editado.pdf'); };
                document.getElementById('edt-success-img').onclick = () => { modal.classList.add('hidden'); switchTab('images'); loadImgPdf(null, new Uint8Array(pdfBytes), 'editado.pdf'); };
                document.getElementById('edt-success-split').onclick = () => { modal.classList.add('hidden'); switchTab('split'); loadSplitPdf(null, new Uint8Array(pdfBytes), 'editado.pdf'); };
                modal.classList.remove('hidden');

            } catch(e) { console.error(e); alert("Error guardando PDF"); }
            finally { hideProgress(); }
        }

        async function editorFlatten() {
            document.getElementById('flatten-modal').classList.add('hidden');
            const fmt = document.querySelector('input[name="flatFormat"]:checked').value; // jpeg or png
            const dpi = parseInt(document.getElementById('flatDpi').value);
            const scale = dpi / 72;
            
            showProgress('Preparando aplanado...', 0);
            try {
                // 1. Generate Edited PDF in memory
                const editedBytes = await generateEditedPdfBytes((i, total) => {
                    showProgress(`Mezclando capas ${i}/${total}...`, (i/total)*40);
                });

                // 2. Load into PDF.js to rasterize
                const loadingTask = pdfjsLib.getDocument(editedBytes);
                const pdf = await loadingTask.promise;
                const total = pdf.numPages;
                
                // 3. Create new PDF container
                const flatPdf = await PDFDocument.create();
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');

                for(let i=1; i<=total; i++) {
                    showProgress(`Rasterizando p치g ${i}/${total}...`, 40 + (i/total)*50);
                    
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: scale });
                    cvs.width = viewport.width;
                    cvs.height = viewport.height;

                    // Fill white background for JPEG/Flattening
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, cvs.width, cvs.height);
                    
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    
                    // Convert to Blob
                    const blob = await new Promise(r => cvs.toBlob(r, `image/${fmt}`, 0.9));
                    const arrayBuffer = await blob.arrayBuffer();
                    
                    // Embed into new PDF
                    let img;
                    if(fmt === 'jpeg') img = await flatPdf.embedJpg(arrayBuffer);
                    else img = await flatPdf.embedPng(arrayBuffer);
                    
                    const newPage = flatPdf.addPage([viewport.width/scale, viewport.height/scale]);
                    newPage.drawImage(img, {
                        x: 0, y: 0,
                        width: viewport.width/scale,
                        height: viewport.height/scale
                    });
                }
                
                showProgress('Guardando...', 95);
                const finalBytes = await flatPdf.save();
                
                const blob = new Blob([finalBytes], {type: 'application/pdf'});
                
                // Show Success Modal
                const modal = document.getElementById('editor-success-modal');
                document.getElementById('edt-success-download').onclick = () => saveBlob(blob, 'aplanado_seguro.pdf');
                document.getElementById('edt-success-org').onclick = () => { modal.classList.add('hidden'); switchTab('organize'); loadOrganizeFromBytes(new Uint8Array(finalBytes), 'aplanado_seguro.pdf'); };
                document.getElementById('edt-success-img').onclick = () => { modal.classList.add('hidden'); switchTab('images'); loadImgPdf(null, new Uint8Array(finalBytes), 'aplanado_seguro.pdf'); };
                document.getElementById('edt-success-split').onclick = () => { modal.classList.add('hidden'); switchTab('split'); loadSplitPdf(null, new Uint8Array(finalBytes), 'aplanado_seguro.pdf'); };
                modal.classList.remove('hidden');

            } catch(e) { console.error(e); alert("Error al aplanar PDF"); }
            finally { hideProgress(); }
        }

        // --- Init Function ---
        function switchTab(tabId) {
            document.querySelectorAll('nav button').forEach(btn => {
                // Determine icon based on tab ID
                let iconName = '';
                if(btn.id === 'tab-merge') iconName = 'combine';
                else if(btn.id === 'tab-split') iconName = 'scissors';
                else if(btn.id === 'tab-organize') iconName = 'layout-grid';
                else if(btn.id === 'tab-images') iconName = 'image';
                else if(btn.id === 'tab-editor') iconName = 'pencil';

                // Base classes
                const baseClasses = "px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2 shadow-sm";
                const activeClasses = "bg-white text-blue-600 dark:bg-gray-600 dark:text-blue-300";
                const inactiveClasses = "text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 shadow-none";

                if(btn.id === `tab-${tabId}`) {
                    btn.className = `${baseClasses} ${activeClasses}`;
                } else {
                    btn.className = `${baseClasses} ${inactiveClasses}`;
                }
            });
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`content-${tabId}`).classList.add('active');
            
            // Re-calc canvas position if editor is opened
            if(tabId === 'editor' && editorState.canvas) {
                editorFitPage();
            }
        }

        const aboutModal = document.getElementById('about-modal');
        document.getElementById('about-btn').onclick = () => aboutModal.classList.remove('hidden');
        document.getElementById('close-about-btn').onclick = () => aboutModal.classList.add('hidden');
        aboutModal.onclick = (e) => { if(e.target === aboutModal) aboutModal.classList.add('hidden'); };

        function showProgress(text, percent) {
            document.getElementById('progressModal').classList.remove('hidden');
            document.getElementById('progressText').innerText = text;
            document.getElementById('progressBar').style.width = `${percent}%`;
        }
        function hideProgress() { document.getElementById('progressModal').classList.add('hidden'); }
        function saveBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        // --- MERGE LOGIC ---
        let mergeFiles = [];
        const mergeList = document.getElementById('mergeList');
        const mergeBtn = document.getElementById('mergeBtn');
        const mergeResultActions = document.getElementById('merge-result-actions');
        let mergeSortable;

        document.getElementById('mergeInput').addEventListener('change', (e) => handleMergeFiles(e.target.files));
        const mergeDropZone = document.getElementById('merge-drop-zone');
        mergeDropZone.addEventListener('dragover', (e) => { e.preventDefault(); mergeDropZone.classList.add('border-blue-500', 'bg-blue-50', 'dark:border-blue-400', 'dark:bg-gray-700'); });
        mergeDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); mergeDropZone.classList.remove('border-blue-500', 'bg-blue-50', 'dark:border-blue-400', 'dark:bg-gray-700'); });
        mergeDropZone.addEventListener('drop', (e) => { e.preventDefault(); mergeDropZone.classList.remove('border-blue-500', 'bg-blue-50', 'dark:border-blue-400', 'dark:bg-gray-700'); handleMergeFiles(e.dataTransfer.files); });

        async function handleMergeFiles(files) {
            mergeResultActions.classList.add('hidden');
            const validFiles = Array.from(files).filter(f => f.type === 'application/pdf' || f.type.startsWith('image/'));
            for (const file of validFiles) {
                let pageCount = 1;
                if(file.type === 'application/pdf') {
                    try {
                        const buff = await file.arrayBuffer();
                        const doc = await PDFDocument.load(buff, { ignoreEncryption: true });
                        pageCount = doc.getPageCount();
                    } catch(e) { console.error(e); continue; }
                }
                mergeFiles.push({ id: crypto.randomUUID(), file: file, isImage: file.type.startsWith('image/'), pageCount: pageCount });
            }
            renderMergeList();
        }

        function renderMergeList() {
            mergeList.innerHTML = '';
            mergeFiles.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between bg-white p-3 rounded-lg border border-gray-200 shadow-sm group hover:border-blue-300 transition-all cursor-grab active:cursor-grabbing dark:bg-gray-800 dark:border-gray-700 dark:hover:border-blue-500";
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden pointer-events-none">
                        <div class="p-2 bg-gray-50 rounded-lg dark:bg-gray-700">${item.isImage ? '<i data-lucide="image" class="w-5 h-5 text-green-600 dark:text-green-400"></i>' : '<i data-lucide="file-text" class="w-5 h-5 text-red-600 dark:text-red-400"></i>'}</div>
                        <div class="min-w-0"><p class="font-medium text-gray-700 truncate text-sm dark:text-gray-200">${item.file.name}</p><p class="text-xs text-gray-400 dark:text-gray-500">${item.pageCount} p치gs</p></div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="removeMergeItem(${index})" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition dark:hover:bg-red-900/30 dark:hover:text-red-400"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                `;
                mergeList.appendChild(div);
            });
            lucide.createIcons();
            mergeBtn.disabled = mergeFiles.length < 2;
            if(mergeSortable) mergeSortable.destroy();
            mergeSortable = new Sortable(mergeList, { animation: 150, ghostClass: 'merge-ghost', dragClass: 'merge-drag', onEnd: (evt) => {
                const item = mergeFiles.splice(evt.oldIndex, 1)[0]; mergeFiles.splice(evt.newIndex, 0, item); renderMergeList();
            }});
        }
        function removeMergeItem(idx) { mergeFiles.splice(idx, 1); renderMergeList(); }
        function clearMergeList() { mergeFiles = []; renderMergeList(); mergeResultActions.classList.add('hidden'); }

        mergeBtn.onclick = async () => {
            showProgress('Uniendo...', 0);
            try {
                const mergedPdf = await PDFDocument.create();
                for(let i=0; i<mergeFiles.length; i++) {
                    const item = mergeFiles[i];
                    showProgress(`Procesando ${item.file.name}...`, (i/mergeFiles.length)*90);
                    const buffer = await item.file.arrayBuffer();
                    if(item.isImage) {
                        const page = mergedPdf.addPage();
                        let img;
                        if(item.file.type === 'image/jpeg') img = await mergedPdf.embedJpg(buffer);
                        else img = await mergedPdf.embedPng(buffer);
                        const { width, height } = img.scale(1);
                        const pW = page.getWidth(), pH = page.getHeight();
                        const scale = Math.min(pW/width, pH/height);
                        page.drawImage(img, { x: (pW - width*scale)/2, y: (pH - height*scale)/2, width: width*scale, height: height*scale });
                    } else {
                        const pdf = await PDFDocument.load(buffer, {ignoreEncryption: true});
                        const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        pages.forEach(p => mergedPdf.addPage(p));
                    }
                }
                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], {type: 'application/pdf'});
                document.getElementById('merge-download-btn').onclick = () => saveBlob(blob, 'unido.pdf');
                document.getElementById('merge-to-organize-btn').onclick = () => { switchTab('organize'); loadOrganizeFromBytes(new Uint8Array(pdfBytes), 'unido.pdf'); };
                document.getElementById('merge-to-editor-btn').onclick = () => { switchTab('editor'); loadEditorPdf(null, new Uint8Array(pdfBytes), 'unido.pdf'); };
                document.getElementById('merge-to-images-btn').onclick = () => { switchTab('images'); loadImgPdf(null, new Uint8Array(pdfBytes), 'unido.pdf'); };
                document.getElementById('merge-to-split-btn').onclick = () => { switchTab('split'); loadSplitPdf(null, new Uint8Array(pdfBytes), 'unido.pdf'); };

                mergeResultActions.classList.remove('hidden');
            } catch(e) { console.error(e); alert('Error al unir'); } finally { hideProgress(); }
        };


        // ==========================================
        // L칍GICA DE DIVIDIR
        // ==========================================
        let splitSelection = new Set();
        let activeSplitPdf = null;
        let activeSplitBytes = null; // Master Source (ArrayBuffer)
        let splitFilename = "";
        const splitRangeInput = document.getElementById('split-range-input');
        const splitModeRadios = document.getElementsByName('split-mode');

        document.getElementById('splitInput').onchange = (e) => loadSplitPdf(e.target.files[0]);

        splitRangeInput.addEventListener('input', () => {
            if(document.querySelector('input[name="split-mode"]:checked').value === 'range') {
                updateVisualFromText();
            }
        });

        splitModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isAll = e.target.value === 'all';
                splitRangeInput.disabled = isAll;
                if (isAll) {
                    splitRangeInput.classList.add('bg-gray-100', 'text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
                    selectAllSplit();
                } else {
                    splitRangeInput.classList.remove('bg-gray-100', 'text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
                    updateVisualFromText();
                }
            });
        });

        // Universal Loader for Split
        async function loadSplitPdf(file, bytes=null, name=null) {
            showProgress('Cargando PDF...', 10);
            try {
                // RESET STATE
                document.querySelector('input[name="split-mode"][value="range"]').checked = true;
                splitRangeInput.value = '';
                splitRangeInput.disabled = false;
                splitRangeInput.classList.remove('bg-gray-100', 'text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');

                if(file) {
                    splitFilename = file.name.replace('.pdf','');
                    activeSplitBytes = await file.arrayBuffer();
                } else if (bytes) {
                    splitFilename = name.replace('.pdf','');
                    activeSplitBytes = bytes.buffer.slice(0); // clone
                }

                const bufferForViewer = activeSplitBytes.slice(0);
                activeSplitPdf = await pdfjsLib.getDocument(bufferForViewer).promise;

                document.getElementById('split-upload').classList.add('hidden');
                document.getElementById('split-workspace').classList.remove('hidden');
                document.getElementById('split-workspace').classList.add('flex');

                renderSplitGrid();
            } catch(e) { console.error(e); alert("Error cargando PDF"); }
            finally { hideProgress(); }
        }

        async function renderSplitGrid() {
            const grid = document.getElementById('splitGrid');
            grid.innerHTML = ''; splitSelection.clear();

            for(let i=1; i<=activeSplitPdf.numPages; i++) {
                const div = document.createElement('div');
                div.className = "relative group cursor-pointer split-page-card";
                div.dataset.page = i;
                div.innerHTML = `
                    <div class="absolute top-2 left-2 z-10 w-6 h-6 bg-white border-2 border-gray-300 rounded transition-colors flex items-center justify-center check-indicator dark:bg-gray-800 dark:border-gray-600">
                        <i data-lucide="check" class="w-4 h-4 text-white opacity-0 transition-opacity"></i>
                    </div>
                    <button onclick="event.stopPropagation(); openZoomModal(${i}, 'split')" class="absolute bottom-2 right-2 p-1.5 bg-white rounded-full shadow-sm hover:bg-gray-100 text-gray-600 transition z-20 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700" title="Ver detalle">
                        <i data-lucide="zoom-in" class="w-4 h-4"></i>
                    </button>
                    <div class="bg-white p-2 rounded-lg shadow-sm border-2 border-transparent hover:border-indigo-300 transition thumbnail-card h-48 flex flex-col items-center justify-center dark:bg-gray-800 dark:hover:border-indigo-500">
                        <canvas id="split-thumb-${i}" class="max-h-full max-w-full object-contain bg-white"></canvas>
                    </div>
                    <div class="text-center mt-1 text-xs text-gray-500 font-medium dark:text-gray-400">P치g ${i}</div>
                `;
                div.onclick = () => toggleSplitPage(i);
                grid.appendChild(div);
                activeSplitPdf.getPage(i).then(page => {
                    const cvs = document.getElementById(`split-thumb-${i}`);
                    const vp = page.getViewport({scale: 0.3});
                    cvs.width = vp.width; cvs.height = vp.height;
                    page.render({canvasContext: cvs.getContext('2d'), viewport: vp});
                });
            }
            lucide.createIcons();
        }

        function toggleSplitPage(n) {
            if(document.querySelector('input[name="split-mode"]:checked').value === 'all') {
                document.querySelector('input[name="split-mode"][value="range"]').checked = true;
                splitRangeInput.disabled = false;
                splitRangeInput.classList.remove('bg-gray-100', 'text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
            }
            if(splitSelection.has(n)) splitSelection.delete(n); else splitSelection.add(n);
            updateSplitGridStyles();
            updateTextFromVisual();
        }

        function selectAllSplit() {
            if(!activeSplitPdf) return;
            for(let i=1; i<=activeSplitPdf.numPages; i++) splitSelection.add(i);
            updateSplitGridStyles();
        }

        function clearSplitSelection() {
            splitSelection.clear();
            if(document.querySelector('input[name="split-mode"]:checked').value === 'all') {
                 document.querySelector('input[name="split-mode"][value="range"]').checked = true;
                 splitRangeInput.disabled = false;
                 splitRangeInput.classList.remove('bg-gray-100', 'text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
            }
            splitRangeInput.value = '';
            updateSplitGridStyles();
        }

        function toggleSplitSelection() {
            const all = activeSplitPdf.numPages;
            if(splitSelection.size === all) splitSelection.clear();
            else {
                const newSel = new Set();
                for(let i=1; i<=all; i++) if(!splitSelection.has(i)) newSel.add(i);
                splitSelection = newSel;
            }
            if(document.querySelector('input[name="split-mode"]:checked').value === 'all') {
                 document.querySelector('input[name="split-mode"][value="range"]').checked = true;
                 splitRangeInput.disabled = false;
                 splitRangeInput.classList.remove('bg-gray-100', 'text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
            }
            updateSplitGridStyles();
            updateTextFromVisual();
        }

        function updateSplitGridStyles() {
            document.querySelectorAll('.split-page-card').forEach(el => {
                const n = parseInt(el.dataset.page);
                const isSel = splitSelection.has(n);
                const indicator = el.querySelector('.check-indicator');
                const checkIcon = el.querySelector('.check-indicator svg') || el.querySelector('.check-indicator i');
                const card = el.querySelector('.thumbnail-card');
                if (!indicator || !card) return;
                if(isSel) {
                    indicator.classList.remove('border-gray-300', 'bg-white', 'dark:border-gray-600', 'dark:bg-gray-800');
                    indicator.classList.add('bg-indigo-600', 'border-indigo-600', 'dark:bg-indigo-500', 'dark:border-indigo-500');
                    if(checkIcon) checkIcon.classList.remove('opacity-0');
                    card.classList.add('border-indigo-600', 'bg-indigo-50', 'dark:border-indigo-500', 'dark:bg-indigo-900/30');
                } else {
                    indicator.classList.add('border-gray-300', 'bg-white', 'dark:border-gray-600', 'dark:bg-gray-800');
                    indicator.classList.remove('bg-indigo-600', 'border-indigo-600', 'dark:bg-indigo-500', 'dark:border-indigo-500');
                    if(checkIcon) checkIcon.classList.add('opacity-0');
                    card.classList.remove('border-indigo-600', 'bg-indigo-50', 'dark:border-indigo-500', 'dark:bg-indigo-900/30');
                }
            });
            document.getElementById('splitCount').innerText = `${splitSelection.size} sel.`;
            document.getElementById('splitBtn').disabled = splitSelection.size === 0;
        }

        function updateTextFromVisual() {
            const arr = Array.from(splitSelection).sort((a,b)=>a-b);
            let ranges = [];
            for (let i = 0; i < arr.length; i++) {
                let start = arr[i], end = start;
                while (i + 1 < arr.length && arr[i + 1] === end + 1) { end = arr[++i]; }
                ranges.push(start === end ? `${start}` : `${start}-${end}`);
            }
            splitRangeInput.value = ranges.join(', ');
        }

        function updateVisualFromText() {
            const text = splitRangeInput.value;
            splitSelection.clear();
            if(!text.trim()) { updateSplitGridStyles(); return; }
            const parts = text.split(',');
            const total = activeSplitPdf.numPages;
            parts.forEach(part => {
                part = part.trim();
                if(!part) return;
                if(part.includes('-')) {
                    let [s, e] = part.split('-');
                    let start = s === '' ? 1 : parseInt(s);
                    let end = e === '' ? total : parseInt(e);
                    if(!isNaN(start)) {
                        if(isNaN(end)) end = total;
                        for(let i=Math.max(1, start); i<=Math.min(total, end); i++) splitSelection.add(i);
                    }
                } else {
                    const p = parseInt(part);
                    if(!isNaN(p) && p>=1 && p<=total) splitSelection.add(p);
                }
            });
            updateSplitGridStyles();
        }

        async function processSplit() {
            const mode = document.querySelector('input[name="split-mode"]:checked').value;
            const forceZip = document.getElementById('split-zip-check').checked;
            let groups = [];
            if (mode === 'all') {
                for(let i=1; i<=activeSplitPdf.numPages; i++) groups.push([i]);
            } else {
                const text = splitRangeInput.value.trim();
                if (!text) return alert("Selecciona p치ginas.");
                const parts = text.split(',');
                const total = activeSplitPdf.numPages;
                parts.forEach(part => {
                    let group = [];
                    part = part.trim();
                    if(!part) return;
                    if(part.includes('-')) {
                        let [s, e] = part.split('-');
                        let start = s===''?1:parseInt(s); let end = e===''?total:parseInt(e);
                        if(!isNaN(start)) { if(isNaN(end)) end=total; for(let i=Math.max(1,start); i<=Math.min(total,end); i++) group.push(i); }
                    } else { const p = parseInt(part); if(!isNaN(p)) group.push(p); }
                    if(group.length>0) groups.push(group);
                });
            }
            if (groups.length === 0) return alert("No hay p치ginas seleccionadas.");

            showProgress('Procesando...', 10);
            try {
                const srcDoc = await PDFDocument.load(activeSplitBytes.slice(0));
                const zip = new JSZip();
                const filesReady = [];
                const padLength = String(activeSplitPdf.numPages).length;

                for(let i=0; i<groups.length; i++) {
                    const group = groups[i];
                    showProgress(`Generando ${i+1}/${groups.length}...`, (i/groups.length)*80);
                    const newDoc = await PDFDocument.create();
                    const indices = group.map(p=>p-1);
                    const copied = await newDoc.copyPages(srcDoc, indices);
                    copied.forEach(p => newDoc.addPage(p));
                    const bytes = await newDoc.save();
                    let name;
                    if(group.length === 1) {
                        name = `${splitFilename}_pag_${String(group[0]).padStart(padLength, '0')}.pdf`;
                    } else {
                        const start = String(group[0]).padStart(padLength, '0');
                        const end = String(group[group.length-1]).padStart(padLength, '0');
                        name = `${splitFilename}_pags_${start}-${end}.pdf`;
                    }
                    filesReady.push({ name: name, blob: new Blob([bytes], {type:'application/pdf'}) });
                }

                if (forceZip) {
                    showProgress('Comprimiendo ZIP...', 95);
                    filesReady.forEach(f => zip.file(f.name, f.blob));
                    const content = await zip.generateAsync({type:'blob'});
                    saveBlob(content, `${splitFilename}_dividido.zip`);
                } else {
                    showDownloadList(filesReady, filesReady.length === 1);
                }
            } catch(e) { console.error(e); alert('Error al procesar'); }
            finally { hideProgress(); }
        }

        // --- UNIVERSAL ZOOM LOGIC ---
        async function openZoomModal(pageNum, context) {
            const modal = document.getElementById('zoom-modal');
            const canvas = document.getElementById('zoom-canvas');
            const ctx = canvas.getContext('2d');
            modal.classList.remove('hidden');
            canvas.width = 0; canvas.height = 0;
            let pdfDoc = null;
            if(context==='split') pdfDoc = activeSplitPdf;
            else if(context==='organize') pdfDoc = activeOrganizePdf;
            else if(context==='images') pdfDoc = activeImgPdf;

            if(!pdfDoc) return;
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            } catch(e) { console.error(e); }
        }

        // Enhanced Download List Modal
        function showDownloadList(files, singleFileMode = false) {
            const listContainer = document.getElementById('download-list');
            listContainer.innerHTML = '';

            // Set up connectors if single file
            const actionsDiv = document.getElementById('single-file-actions');
            if (singleFileMode) {
                actionsDiv.classList.remove('hidden');
                actionsDiv.classList.add('flex');
                const bytes = new Uint8Array(2); // Mock, real one needed.
                // NOTE: We need the ArrayBuffer from the blob for connectors.
                const file = files[0];
                file.blob.arrayBuffer().then(buffer => {
                    const u8 = new Uint8Array(buffer);
                    document.getElementById('res-to-org-btn').onclick = () => {
                        document.getElementById('download-result-modal').classList.add('hidden');
                        switchTab('organize');
                        loadOrganizeFromBytes(u8, file.name);
                    };
                    document.getElementById('res-to-editor-btn').onclick = () => {
                        document.getElementById('download-result-modal').classList.add('hidden');
                        switchTab('editor');
                        loadEditorPdf(null, u8, file.name);
                    };
                    document.getElementById('res-to-img-btn').onclick = () => {
                        document.getElementById('download-result-modal').classList.add('hidden');
                        switchTab('images');
                        loadImgPdf(null, u8, file.name);
                    };
                });
            } else {
                actionsDiv.classList.add('hidden');
                actionsDiv.classList.remove('flex');
            }

            files.forEach(f => {
                const url = URL.createObjectURL(f.blob);
                const item = document.createElement('div');
                item.className = "flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition dark:bg-gray-700 dark:border-gray-600 dark:hover:bg-gray-600";
                const icon = f.name.endsWith('.pdf') ? 'file-text' : 'image';
                const color = f.name.endsWith('.pdf') ? 'text-indigo-500 dark:text-indigo-400' : 'text-green-500 dark:text-green-400';
                item.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i data-lucide="${icon}" class="w-5 h-5 ${color} flex-shrink-0"></i>
                        <span class="text-sm font-medium text-gray-700 truncate dark:text-gray-200">${f.name}</span>
                    </div>
                    <a href="${url}" download="${f.name}" class="text-blue-600 hover:text-blue-800 bg-white p-2 rounded border border-gray-200 hover:border-blue-300 shadow-sm transition dark:bg-gray-600 dark:border-gray-500 dark:text-blue-300 dark:hover:bg-gray-500"><i data-lucide="download" class="w-4 h-4"></i></a>
                `;
                listContainer.appendChild(item);
            });
            lucide.createIcons();
            document.getElementById('download-result-modal').classList.remove('hidden');
        }


        // --- ORGANIZE LOGIC ---
        let organizeOriginalBytes = null; let organizeFilename = ""; let organizeRotations = {}; let activeOrganizePdf = null;
        document.getElementById('organizeInput').onchange = (e) => loadOrganizeFile(e.target.files[0]);
        async function loadOrganizeFile(file) { if(!file)return; const b=await file.arrayBuffer(); loadOrganizeFromBytes(new Uint8Array(b), file.name); }
        async function loadOrganizeFromBytes(u8, name) {
            showProgress('Cargando...', 20); organizeOriginalBytes = u8; organizeFilename = name;
            document.getElementById('organize-filename').innerText = name;
            document.getElementById('organize-upload').classList.add('hidden');
            document.getElementById('organize-workspace').classList.remove('hidden');
            document.getElementById('organize-workspace').classList.add('flex');
            try {
                activeOrganizePdf = await pdfjsLib.getDocument(organizeOriginalBytes.buffer.slice(0)).promise;
                document.getElementById('organize-page-count').innerText = `${activeOrganizePdf.numPages} p치gs`;
                const grid = document.getElementById('organizeGrid'); grid.innerHTML = ''; organizeRotations = {};
                for(let i=1; i<=activeOrganizePdf.numPages; i++) {
                    const div = document.createElement('div'); div.className = "relative group cursor-grab active:cursor-grabbing bg-white p-2 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition dark:bg-gray-800 dark:border-gray-700"; div.dataset.page = i;
                    div.innerHTML = `<div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition z-10"><button onclick="event.stopPropagation(); rotateOrgPage(${i})" class="bg-white p-1.5 rounded shadow text-gray-600 hover:text-orange-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:text-orange-400"><i data-lucide="rotate-cw" class="w-4 h-4"></i></button><button onclick="event.stopPropagation(); deleteOrgPage(this)" class="bg-white p-1.5 rounded shadow text-gray-600 hover:text-red-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:text-red-400"><i data-lucide="trash" class="w-4 h-4"></i></button></div><button onclick="event.stopPropagation(); openZoomModal(${i}, 'organize')" class="absolute bottom-2 right-2 p-1.5 bg-white rounded-full shadow-sm hover:bg-gray-100 text-gray-600 transition z-20 opacity-0 group-hover:opacity-100 dark:bg-gray-700 dark:text-gray-300" title="Ver detalle"><i data-lucide="zoom-in" class="w-4 h-4"></i></button><div class="overflow-hidden h-40 flex items-center justify-center bg-gray-50 rounded dark:bg-gray-700"><canvas id="org-cvs-${i}" class="max-h-full max-w-full object-contain transition-transform duration-300 bg-white"></canvas></div><div class="text-center text-xs text-gray-400 mt-2 font-mono">${i}</div>`;
                    grid.appendChild(div);
                    activeOrganizePdf.getPage(i).then(page => { const cvs = document.getElementById(`org-cvs-${i}`); const vp = page.getViewport({scale: 0.3}); cvs.width = vp.width; cvs.height = vp.height; page.render({canvasContext: cvs.getContext('2d'), viewport: vp}); });
                }
                lucide.createIcons(); new Sortable(grid, { animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag' });
            } catch(e) { console.error(e); alert('Error'); } finally { hideProgress(); }
        }
        window.rotateOrgPage = (n) => { organizeRotations[n] = ((organizeRotations[n]||0)+90)%360; document.getElementById(`org-cvs-${n}`).style.transform = `rotate(${organizeRotations[n]}deg)`; };
        window.deleteOrgPage = (btn) => btn.closest('.relative').remove();
        document.getElementById('organize-save-btn').onclick = async () => {
            showProgress('Guardando...', 50);
            try {
                const src = await PDFDocument.load(organizeOriginalBytes.buffer.slice(0), {ignoreEncryption:true});
                const doc = await PDFDocument.create();
                const cards = document.querySelectorAll('#organizeGrid > div');
                const idxs = Array.from(cards).map(c => parseInt(c.dataset.page)-1);
                if(idxs.length===0) throw new Error;
                const copied = await doc.copyPages(src, idxs);
                cards.forEach((c, i) => { const p = copied[i]; const r = organizeRotations[parseInt(c.dataset.page)]||0; p.setRotation(degrees((p.getRotation().angle+r)%360)); doc.addPage(p); });
                const pdfBytes = await doc.save();
                const blob = new Blob([pdfBytes], {type: 'application/pdf'});

                // --- SUCCESS MODAL ---
                const successModal = document.getElementById('organize-success-modal');
                document.getElementById('org-success-download').onclick = () => saveBlob(blob, `organizado_${organizeFilename}`);
                document.getElementById('org-success-editor').onclick = () => { successModal.classList.add('hidden'); switchTab('editor'); loadEditorPdf(null, new Uint8Array(pdfBytes), `organizado_${organizeFilename}`); };
                document.getElementById('org-success-img').onclick = () => { successModal.classList.add('hidden'); switchTab('images'); loadImgPdf(null, new Uint8Array(pdfBytes), `organizado_${organizeFilename}`); };
                document.getElementById('org-success-split').onclick = () => { successModal.classList.add('hidden'); switchTab('split'); loadSplitPdf(null, new Uint8Array(pdfBytes), `organizado_${organizeFilename}`); };
                successModal.classList.remove('hidden');

            } catch(e) { alert('Error al guardar'); } finally { hideProgress(); }
        };

        // ==========================================
        // L칍GICA DE IM츼GENES (RENOVADA)
        // ==========================================
        let imgSel = new Set(); let activeImgPdf = null; let imgName = "";
        const imgRangeInput = document.getElementById('img-range-input');

        document.getElementById('imagesInput').onchange = (e) => loadImgPdf(e.target.files[0]);

        // Sync Logic
        imgRangeInput.addEventListener('input', () => {
            if(document.querySelector('input[name="img-mode"]:checked').value === 'range') updateImgVisualFromText();
        });
        document.getElementsByName('img-mode').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const isAll = e.target.value === 'all';
                imgRangeInput.disabled = isAll;
                if(isAll) {
                    imgRangeInput.classList.add('bg-gray-100','text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
                    selectAllImg();
                } else {
                    imgRangeInput.classList.remove('bg-gray-100','text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
                    updateImgVisualFromText();
                }
            });
        });

        // Universal Loader for Images
        async function loadImgPdf(f, bytes=null, name=null) {
            showProgress('Cargando...',10);

            if(f) {
                imgName=f.name.replace('.pdf','');
                activeImgPdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
            } else if (bytes) {
                imgName = name.replace('.pdf','');
                activeImgPdf = await pdfjsLib.getDocument(bytes.buffer.slice(0)).promise;
            } else { return; }

            // RESET STATE
            document.querySelector('input[name="img-mode"][value="range"]').checked = true;
            imgRangeInput.value = '';
            imgRangeInput.disabled = false;
            imgRangeInput.classList.remove('bg-gray-100', 'text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');

            document.getElementById('images-upload').classList.add('hidden'); document.getElementById('images-workspace').classList.remove('hidden'); document.getElementById('images-workspace').classList.add('flex');

            const g = document.getElementById('imagesGrid'); g.innerHTML=''; imgSel.clear();

            for(let i=1; i<=activeImgPdf.numPages; i++) {
                const d = document.createElement('div'); d.className="relative group cursor-pointer img-page-card"; d.dataset.page = i;
                d.innerHTML=`<div class="absolute top-2 left-2 z-10 w-6 h-6 bg-white border-2 border-gray-300 rounded transition-colors flex items-center justify-center check-indicator dark:bg-gray-800 dark:border-gray-600"><i data-lucide="check" class="w-4 h-4 text-white opacity-0 transition-opacity"></i></div><button onclick="event.stopPropagation(); openZoomModal(${i}, 'images')" class="absolute bottom-2 right-2 p-1.5 bg-white rounded-full shadow-sm hover:bg-gray-100 text-gray-600 transition z-20 dark:bg-gray-800 dark:text-gray-300" title="Ver detalle"><i data-lucide="zoom-in" class="w-4 h-4"></i></button><div class="bg-white p-2 rounded-lg shadow-sm border-2 border-transparent hover:shadow-md cursor-pointer flex flex-col items-center img-card dark:bg-gray-800 dark:hover:border-green-500"><canvas class="w-full h-auto border border-gray-100 mb-2 bg-white"></canvas><span class="text-xs text-gray-500 dark:text-gray-400">P치g ${i}</span></div>`;
                const c = d.querySelector('canvas');
                d.onclick=()=>toggleImgPage(i);
                g.appendChild(d);
                activeImgPdf.getPage(i).then(p => { const vp=p.getViewport({scale:0.3}); c.width=vp.width; c.height=vp.height; p.render({canvasContext:c.getContext('2d'), viewport:vp}); });
            }
            lucide.createIcons(); hideProgress(); updateImgUI();
        }

        function toggleImgPage(n) {
            if(document.querySelector('input[name="img-mode"]:checked').value === 'all') {
                document.querySelector('input[name="img-mode"][value="range"]').checked=true;
                imgRangeInput.disabled=false; imgRangeInput.classList.remove('bg-gray-100','text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
            }
            if(imgSel.has(n)) imgSel.delete(n); else imgSel.add(n);
            updateImgGridStyles(); updateImgTextFromVisual();
        }
        function selectAllImg() { if(activeImgPdf) for(let i=1;i<=activeImgPdf.numPages;i++) imgSel.add(i); updateImgGridStyles(); }
        function clearImgSelection() {
            imgSel.clear();
            if(document.querySelector('input[name="img-mode"]:checked').value === 'all') {
                document.querySelector('input[name="img-mode"][value="range"]').checked=true;
                imgRangeInput.disabled=false; imgRangeInput.classList.remove('bg-gray-100','text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
            }
            imgRangeInput.value=''; updateImgGridStyles();
        }
        function toggleImgSelection() {
            const all = activeImgPdf.numPages;
            if(imgSel.size===all) imgSel.clear(); else { const n=new Set(); for(let i=1;i<=all;i++) if(!imgSel.has(i)) n.add(i); imgSel=n; }
            if(document.querySelector('input[name="img-mode"]:checked').value === 'all') {
                document.querySelector('input[name="img-mode"][value="range"]').checked=true;
                imgRangeInput.disabled=false; imgRangeInput.classList.remove('bg-gray-100','text-gray-400', 'dark:bg-gray-800', 'dark:text-gray-500');
            }
            updateImgGridStyles(); updateImgTextFromVisual();
        }

        function updateImgGridStyles() {
            document.querySelectorAll('.img-page-card').forEach(el => {
                const n = parseInt(el.dataset.page);
                const isSel = imgSel.has(n);
                const ind = el.querySelector('.check-indicator');
                const icon = el.querySelector('.check-indicator svg') || el.querySelector('.check-indicator i');
                const card = el.querySelector('.img-card');
                if (!ind || !card) return;

                if(isSel){
                    ind.classList.remove('border-gray-300','bg-white', 'dark:border-gray-600', 'dark:bg-gray-800');
                    ind.classList.add('bg-green-600','border-green-600', 'dark:bg-green-500', 'dark:border-green-500');
                    if(icon) icon.classList.remove('opacity-0');
                    card.classList.add('border-green-500','bg-green-50', 'dark:border-green-500', 'dark:bg-green-900/30');
                } else {
                    ind.classList.add('border-gray-300','bg-white', 'dark:border-gray-600', 'dark:bg-gray-800');
                    ind.classList.remove('bg-green-600','border-green-600', 'dark:bg-green-500', 'dark:border-green-500');
                    if(icon) icon.classList.add('opacity-0');
                    card.classList.remove('border-green-500','bg-green-50', 'dark:border-green-500', 'dark:bg-green-900/30');
                }
            });
            updateImgUI();
        }
        function updateImgTextFromVisual() {
            const arr = Array.from(imgSel).sort((a,b)=>a-b);
            let ranges = [];
            for (let i = 0; i < arr.length; i++) {
                let start = arr[i], end = start;
                while (i + 1 < arr.length && arr[i + 1] === end + 1) end = arr[++i];
                ranges.push(start === end ? `${start}` : `${start}-${end}`);
            }
            imgRangeInput.value = ranges.join(', ');
        }
        function updateImgVisualFromText() {
            const txt=imgRangeInput.value; imgSel.clear(); if(!txt.trim()){updateImgGridStyles();return;}
            const total=activeImgPdf.numPages;
            txt.split(',').forEach(p=>{
                p=p.trim(); if(!p)return;
                if(p.includes('-')){
                    let [s,e]=p.split('-'); let start=s===''?1:parseInt(s); let end=e===''?total:parseInt(e);
                    if(!isNaN(start)){ if(isNaN(end))end=total; for(let i=Math.max(1,start);i<=Math.min(total,end);i++) imgSel.add(i); }
                } else { const n=parseInt(p); if(!isNaN(n)&&n>=1&&n<=total) imgSel.add(n); }
            });
            updateImgGridStyles();
        }
        function updateImgUI(){ document.getElementById('imgSelectionCount').innerText=`${imgSel.size} sel.`; document.getElementById('imgProcessBtn').disabled=imgSel.size===0; }

        async function processImages(){
            if(imgSel.size===0)return; const fmt=document.querySelector('input[name="imgFormat"]:checked').value; const dpi=parseInt(document.getElementById('imgDpi').value);
            const scale=dpi/72; const pgs=Array.from(imgSel).sort((a,b)=>a-b);
            const forceZip = document.getElementById('img-zip-check').checked;

            showProgress('Iniciando...',0); const zip=new JSZip(); const cvs=document.getElementById('exportCanvas'); const ctx=cvs.getContext('2d');
            const filesReady = []; const padLen = String(activeImgPdf.numPages).length;

            try {
                for(let i=0;i<pgs.length;i++){
                    const pn=pgs[i]; showProgress(`Convirtiendo p치g ${pn}...`,(i/pgs.length)*90);
                    const p=await activeImgPdf.getPage(pn); const vp=p.getViewport({scale}); cvs.width=vp.width; cvs.height=vp.height;
                    if(fmt==='jpeg'){ctx.fillStyle='#FFF';ctx.fillRect(0,0,cvs.width,cvs.height);}else ctx.clearRect(0,0,cvs.width,cvs.height);
                    await p.render({canvasContext:ctx,viewport:vp}).promise;
                    const b=await new Promise(r=>cvs.toBlob(r,`image/${fmt}`,0.9));
                    const pad=String(pn).padStart(padLen,'0'); const fn=`${imgName}_pag_${pad}.${fmt==='jpeg'?'jpg':'png'}`;

                    filesReady.push({name:fn, blob:b});
                    cvs.width=1;cvs.height=1;
                }

                if(forceZip) {
                    showProgress('Comprimiendo...', 95);
                    filesReady.forEach(f => zip.file(f.name, f.blob));
                    saveBlob(await zip.generateAsync({type:'blob'}),`${imgName}_imagenes.zip`);
                } else {
                    showDownloadList(filesReady);
                }
            } catch(e){console.error(e);alert('Error');} finally{hideProgress();}
        }

        function resetTool(t) { document.getElementById(`${t}-upload`).classList.remove('hidden'); document.getElementById(`${t}-workspace`).classList.add('hidden'); document.getElementById(`${t}-workspace`).classList.remove('flex'); }
        lucide.createIcons();
    </script>
</body>
</html>
